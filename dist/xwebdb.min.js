!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).xwebdb={})}(this,(function(t){"use strict";const e=[];for(let t=0;t<256;t++)e[t]=(t<16?"0":"")+t.toString(16);function r(){let t=4294967295*Math.random()|0,r=4294967295*Math.random()|0,i=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return e[255&t]+e[t>>8&255]+e[t>>16&255]+e[t>>24&255]+"-"+e[255&r]+e[r>>8&255]+"-"+e[r>>16&15|64]+e[r>>24&255]+"-"+e[63&i|128]+e[i>>8&255]+"-"+e[i>>16&255]+e[i>>24&255]+e[255&n]+e[n>>8&255]+e[n>>16&255]+e[n>>24&255]}function i(t=8){return Array.from(new Uint8Array(120)).map((t=>Math.random().toString(36))).join("").split("0.").join("").substring(0,t)}function n(t,e=0){const r=(new TextEncoder).encode(t),i=2654435761;let n=e+3735928559,s=r.length;for(let t=0;t+4<=s;t+=4){n+=((r[t]|r[t+1]<<8|r[t+2]<<16|r[t+3]<<24)>>>0)*i,n=Math.imul(n,i)}if(3&s){let t=r.slice(s-(3&s)),e=0;for(let r=0;r<t.length;r++)e+=t[r]<<8*r;n+=e*i,n=Math.imul(n,i)}return n^=n>>>15,n=Math.imul(n,i),n^=n>>>13,n=Math.imul(n,i),n^=n>>>16,n>>>0}var s=Object.freeze({__proto__:null,uid:r,randomString:i,xxh:n});function o(t,e){if("number"==typeof t&&(t=t.toString()),!("$"!==t[0]||"$$date"===t&&"number"==typeof e||"$$deleted"===t&&!0===e||"$$indexCreated"===t||"$$indexRemoved"===t))throw new Error("Field names cannot begin with the $ character");if(-1!==t.indexOf("."))throw new Error("Field names cannot contain a .")}function a(t){Array.isArray(t)?t.forEach((t=>a(t))):"object"!=typeof t||null===t||t instanceof Date||Object.keys(t).forEach((function(e){o(e,t[e]),a(t[e])}))}function h(t){return JSON.stringify(t,(function(t,e){if(o(t,e),void 0!==e)return null===e?null:"function"==typeof this[t].getTime?{$$date:this[t].getTime()}:e}))}function l(t){return JSON.parse(t,(function(t,e){return"$$date"===t?new Date(e):"string"==typeof e||"number"==typeof e||"boolean"==typeof e||null===e?e:e&&e.$$date?e.$$date:e}))}function d(t,e,r){let i;return"boolean"==typeof t||"number"==typeof t||"string"==typeof t||null===t||t instanceof Date?t:Array.isArray(t)?(i=[],t.forEach((t=>i.push(d(t,e,r)))),i):"object"==typeof t?(i={},Object.keys(t).forEach((n=>{(!r||"$"!==n[0]&&-1===n.indexOf("."))&&(i[n]=d(t[n],e,r))})),i.hasOwnProperty("_id")?e.new(i):i):JSON.parse(JSON.stringify({temp:t})).temp}function u(t){return"boolean"==typeof t||"number"==typeof t||"string"==typeof t||null===t||t instanceof Date||Array.isArray(t)}function c(t,e){return t<e?-1:t>e?1:0}function f(t,e){for(let r=0;r<Math.min(t.length,e.length);r+=1){let i=y(t[r],e[r]);if(0!==i)return i}return c(t.length,e.length)}function y(t,e,r){const i=r||c;if(void 0===t)return void 0===e?0:-1;if(void 0===e)return void 0===t?0:1;if(null===t)return null===e?0:-1;if(null===e)return null===t?0:1;if("number"==typeof t)return"number"==typeof e?c(t,e):-1;if("number"==typeof e)return"number"==typeof t?c(t,e):1;if("string"==typeof t)return"string"==typeof e?i(t,e):-1;if("string"==typeof e)return"string"==typeof t?i(t,e):1;if("boolean"==typeof t)return"boolean"==typeof e?c(t,e):-1;if("boolean"==typeof e)return"boolean"==typeof t?c(t,e):1;if(t instanceof Date)return e instanceof Date?c(t.getTime(),e.getTime()):-1;if(e instanceof Date)return t instanceof Date?c(t.getTime(),e.getTime()):1;if(Array.isArray(t))return Array.isArray(e)?f(t,e):-1;if(Array.isArray(e))return Array.isArray(t)?f(t,e):1;let n=Object.keys(t).sort(),s=Object.keys(e).sort();for(let r=0;r<Math.min(n.length,s.length);r+=1){let i=y(t[n[r]],e[s[r]]);if(0!==i)return i}return c(n.length,s.length)}const p={$set:function(t,e,r){t&&(t[e]=r)},$mul:function(t,e,r){let i=t[e];if("number"!=typeof r||"number"!=typeof i)throw new Error("Multiply operator works only on numbers");t[e]=i*r},$unset:function(t,e){delete t[e]},$push:function(t,e,r){if(t.hasOwnProperty(e)||(t[e]=[]),!Array.isArray(t[e]))throw new Error("Can't $push an element on non-array values");if(null!==r&&"object"==typeof r&&r.$slice&&void 0===r.$each&&(r.$each=[]),null!==r&&"object"==typeof r&&r.$each){const i=r.$each,n=r.$slice,s=r.$position,o=r.$sort,a=Object.keys(r);if(Object.keys(r).length>1&&a.filter((t=>-1===["$each","$slice","$position","$sort"].indexOf(t))).length)throw new Error("Can only use the modifiers $slice, $position and $sort in conjunction with $each when $push to array");if(!Array.isArray(i))throw new Error("$each requires an array value");if(s)for(let r=0;r<i.length;r++){const n=i[r];t[e].splice(s+r,0,n)}else i.forEach((r=>t[e].push(r)));if(o&&("number"==typeof o?1===o?t[e].sort(((t,e)=>y(t,e))):t[e].sort(((t,e)=>y(e,t))):t[e].sort(((t,e)=>{const r=Object.keys(o);for(let i=0;i<r.length;i++){const n=r[i];if(1===o[n]){const r=y(t[n],e[n]);if(r)return r}else{const r=y(e[n],t[n]);if(r)return r}}return 0}))),void 0===n)return;if(void 0!==n&&"number"!=typeof n)throw new Error("$slice requires a number value");if(0===n)t[e]=[];else{let r=0,i=0,s=t[e].length;n<0?(r=Math.max(0,s+n),i=s):n>0&&(r=0,i=Math.min(s,n)),t[e]=t[e].slice(r,i)}}else t[e].push(r)},$addToSet:function(t,e,r){if(t.hasOwnProperty(e)||(t[e]=[]),!Array.isArray(t[e]))throw new Error("Can't $addToSet an element on non-array values");const i=r.$each;if(null!==r&&"object"==typeof r&&i){if(Object.keys(r).length>1)throw new Error("Can't use another field in conjunction with $each on $addToSet modifier");if(!Array.isArray(i))throw new Error("$each requires an array value");i.forEach((r=>p.$addToSet(t,e,r)))}else{let i=!0;for(let n=0;n<t[e].length;n++){if(0===y(t[e][n],r)){i=!1;break}}i&&t[e].push(r)}},$pop:function(t,e,r){if(!Array.isArray(t[e]))throw new Error("Can't $pop an element from non-array values");if("number"!=typeof r)throw new Error(r+" isn't an integer, can't use it with $pop");0!==r&&(t[e]=r>0?t[e].slice(0,t[e].length-1):t[e].slice(1))},$pull:function(t,e,r){if(!Array.isArray(t[e]))throw new Error("Can't $pull an element from non-array values");let i=t[e];for(let t=i.length-1;t>=0;t-=1)A(i[t],r)&&i.splice(t,1)},$pullAll:function(t,e,r){if(!Array.isArray(t[e]))throw new Error("Can't $pull an element from non-array values");let i=t[e];for(let t=i.length-1;t>=0;t-=1)for(let e=0;e<r.length;e++)A(i[t],r[e])&&i.splice(t,1)},$inc:function(t,e,r){if("number"!=typeof r)throw new Error(r+" must be a number");if("number"!=typeof t[e]){if(t.hasOwnProperty(e))throw new Error("Can't use the $inc modifier on non-number fields");t[e]=r}else t[e]=t[e]+r},$max:function(t,e,r){(void 0===t[e]||r>t[e])&&(t[e]=r)},$min:function(t,e,r){(void 0===t[e]||r<t[e])&&(t[e]=r)},$currentDate:function(t,e,r){!0===r?t[e]=new Date:r.$type&&"timestamp"===r.$type?t[e]=Date.now():r.$type&&"date"===r.$type&&(t[e]=new Date)},$rename:function(t,e,r){t[r]=t[e],delete t[e]},$setOnInsert:function(){}};const g={};function m(t,e,r){var i=Object.keys(e);let n,s=i.map((t=>t.charAt(0))),o=s.filter((t=>"$"===t));if(-1!==i.indexOf("_id")&&e._id!==t._id)throw new Error("You cannot change a document's _id");if(0!==o.length&&o.length!==s.length)throw new Error("You cannot mix modifiers and normal fields");if(0===o.length)n=d(e,r),n._id=t._id;else{let s=Array.from(new Set(i));n=d(t,r),s.forEach((function(t){let r=e[t];if(!g[t])throw new Error("Unknown modifier "+t);if("object"!=typeof r)throw new Error("Modifier "+t+"'s argument must be an object");Object.keys(r).forEach((function(e){g[t](n,e,r[e])}))}))}if(a(n),t._id!==n._id)throw new Error("You can't change a document's _id");return n}function v(t,e){const r="string"==typeof e?e.split("."):e;if(t){if(0===r.length)return t;if(1===r.length)return t[r[0]];if(Array.isArray(t[r[0]])){let e=parseInt(r[1],10);if("number"==typeof e&&!isNaN(e))return v(t[r[0]][e],r.slice(2));let i=new Array;for(let e=0;e<t[r[0]].length;e+=1)i.push(v(t[r[0]][e],r.slice(1)));return i}return v(t[r[0]],r.slice(1))}}function w(t,e){var r,i,n;if(null===t||"string"==typeof t||"boolean"==typeof t||"number"==typeof t||null===e||"string"==typeof e||"boolean"==typeof e||"number"==typeof e)return t===e;if(t instanceof Date||e instanceof Date)return t instanceof Date&&e instanceof Date&&t.getTime()===e.getTime();if((!Array.isArray(t)||!Array.isArray(e))&&(Array.isArray(t)||Array.isArray(e))||void 0===t||void 0===e)return!1;try{r=Object.keys(t),i=Object.keys(e)}catch(t){return!1}if(r.length!==i.length)return!1;for(n=0;n<r.length;n+=1){if(-1===i.indexOf(r[n]))return!1;if(!w(t[r[n]],e[r[n]]))return!1}return!0}function $(t,e){return("string"==typeof t||"number"==typeof t||t instanceof Date||"string"==typeof e||"number"==typeof e||e instanceof Date)&&typeof t==typeof e}Object.keys(p).forEach((function(t){g[t]=function(t){return function(e,r,i){var n="string"==typeof r?r.split("."):r;if(1===n.length)p[t](e,r,i);else{if(void 0===e[n[0]]){if("$unset"===t)return;e[n[0]]={}}g[t](e[n[0]],n.slice(1).join("."),i)}}}(t)}));const _={$type:function(t,e){return["number","boolean","string","undefined"].indexOf(e)>-1?typeof t===e:"array"===e?Array.isArray(t):"null"===e?null===t:"date"===e?t instanceof Date:"object"===e&&!("object"!=typeof t||t instanceof Date||null===t||Array.isArray(t))},$not:function(t,e){return!A({k:t},{k:e})},$eq:function(t,e){return w(t,e)},$lt:function(t,e){return $(t,e)&&t<e},$lte:function(t,e){return $(t,e)&&t<=e},$gt:function(t,e){return $(t,e)&&t>e},$gte:function(t,e){return $(t,e)&&t>=e},$mod:function(t,e){if(!Array.isArray(e))throw new Error("malformed mod, must be supplied with an array");if(2!==e.length)throw new Error("malformed mod, array length must be exactly two, a divisor and a remainder");return t%e[0]===e[1]},$ne:function(t,e){return void 0===t||!w(t,e)},$in:function(t,e){var r;if(!Array.isArray(e))throw new Error("$in operator called with a non-array");for(r=0;r<e.length;r+=1)if(w(t,e[r]))return!0;return!1},$nin:function(t,e){if(!Array.isArray(e))throw new Error("$nin operator called with a non-array");return!_.$in(t,e)},$regex:function(t,e){if(!(e instanceof RegExp))throw new Error("$regex operator called with non regular expression");return"string"==typeof t&&e.test(t)},$exists:function(t,e){return e=!(!e&&""!==e),void 0===t?!e:e},$size:function(t,e){if(!Array.isArray(t))return!1;if(e%1!=0)throw new Error("$size operator called without an integer");return t.length===e},$elemMatch:function(t,e){if(!Array.isArray(t))return!1;for(var r=t.length,i=!1;r--;)if(A(t[r],e)){i=!0;break}return i},$all:function(t,e){if(!Array.isArray(t))throw new Error("$all must be applied on fields of type array");if(!Array.isArray(e))throw new Error("$all must be supplied with argument of type array");for(let r=0;r<e.length;r++){const i=e[r];if(-1===t.indexOf(i))return!1}return!0}},b={$size:!0,$elemMatch:!0,$all:!0},x={};function A(t,e){if(u(t)||u(e))return E({needAKey:t},"needAKey",e);let r=Object.keys(e);for(let i=0;i<r.length;i+=1){let n=r[i],s=e[n];if("$"===n[0]){if(!x[n])throw new Error("Unknown logical operator "+n);if(!x[n](t,s))return!1}else if(!E(t,n,s))return!1}return!0}function E(t,e,r,i){const n=v(t,e);if(Array.isArray(n)&&!i){if(Array.isArray(r))return E(t,e,r,!0);if(null!==r&&"object"==typeof r&&!(r instanceof RegExp)){let i=Object.keys(r);for(let n=0;n<i.length;n+=1)if(b[i[n]])return E(t,e,r,!0)}for(let t=0;t<n.length;t+=1){if(r.$ne&&-1!==n.indexOf(r.$ne))return!1;if(Array.isArray(r.$nin)){if(r.$nin.filter((t=>-1!==n.indexOf(t))).length)return!1}if(E({k:n[t]},"k",r))return!0}return!1}if(!(null===r||"object"!=typeof r||r instanceof RegExp||Array.isArray(r))){let t=Object.keys(r),e=t.map((t=>t[0])),i=e.filter((t=>"$"===t));if(0!==i.length&&i.length!==e.length)throw new Error("You cannot mix operators and normal fields");if(i.length>0){for(let e=0;e<t.length;e+=1){if(!_[t[e]])throw new Error("Unknown comparison function "+t[e]);if(!_[t[e]](n,r[t[e]]))return!1}return!0}}return r instanceof RegExp?_.$regex(n,r):!!w(n,r)}x.$or=function(t,e){var r;if(!Array.isArray(e))throw new Error("$or operator used without an array");for(r=0;r<e.length;r+=1)if(A(t,e[r]))return!0;return!1},x.$and=function(t,e){if(!Array.isArray(e))throw new Error("$and operator used without an array");for(let r=0;r<e.length;r+=1)if(!A(t,e[r]))return!1;return!0},x.$nor=function(t,e){if(!Array.isArray(e))throw new Error("$nor operator used without an array");for(let r=0;r<e.length;r+=1)if(A(t,e[r]))return!1;return!0},x.$where=function(t,e){var r;if("function"!=typeof e)throw new Error("$where operator used without a function");if("boolean"!=typeof(r=e.call(t)))throw new Error("$where function must return boolean");return r};var k=Object.freeze({__proto__:null,serialize:h,deserialize:l,deepCopy:d,checkObject:a,isPrimitiveType:u,modify:m,getDotValue:v,match:A,areThingsEqual:w,compareThings:y});function O(t,e,r,i){return new(r||(r=Promise))((function(n,s){function o(t){try{h(i.next(t))}catch(t){s(t)}}function a(t){try{h(i.throw(t))}catch(t){s(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(o,a)}h((i=i.apply(t,e||[])).next())}))}class D{constructor(t,e){this.db=t,this.query=e||{}}limit(t){return this._limit=t,this}skip(t){return this._skip=t,this}sort(t){return this._sort=t,this}projection(t){return this._projection=t,this}_project(t){if(void 0===this._projection||0===Object.keys(this._projection).length)return t;let e=[],r=0!==this._projection._id;delete this._projection._id;let i=Object.keys(this._projection),n=i.map((t=>this._projection[t])).sort();if(n[0]!==n[n.length-1])throw new Error("Can't both keep and omit fields except for _id");let s=n[0];return t.forEach((t=>{let n={};1===s?(n={$set:{}},i.forEach((e=>{n.$set[e]=v(t,e),void 0===n.$set[e]&&delete n.$set[e]})),n=m({},n,this.db.model)):(n={$unset:{}},i.forEach((t=>{n.$unset[t]=!0})),n=m(t,n,this.db.model)),r?n._id=t._id:delete n._id,e.push(n)})),e}__exec_unsafe(){return O(this,void 0,void 0,(function*(){let t=[],e=0,r=0;const i=yield this.db.getCandidates(this.query);for(let n=0;n<i.length;n++)if(A(i[n],this.query))if(this._sort)t.push(i[n]);else if(this._skip&&this._skip>r)r++;else if(t.push(i[n]),e++,this._limit&&this._limit<=e)break;if(this._sort){let e=Object.keys(this._sort);const r=[];for(let t=0;t<e.length;t++){let i=e[t];r.push({key:i,direction:this._sort[i]})}t.sort(((t,e)=>{let i,n,s;for(s=0;s<r.length;s++)if(i=r[s],n=i.direction*y(v(t,i.key),v(e,i.key)),0!==n)return n;return 0}));const i=this._limit||t.length,n=this._skip||0;t=t.slice(n,n+i)}return t=this._project(t),t}))}_exec(){return O(this,void 0,void 0,(function*(){return this.db.q.add((()=>this.__exec_unsafe()))}))}exec(){return O(this,void 0,void 0,(function*(){const t=yield this._exec(),e=[];for(let r=0;r<t.length;r++)e.push(d(t[r],this.db.model));return e}))}}class j{constructor(t,e){this.left=null,this.right=null,this.height=null,this.value=[],this.value.push(e),this.key=t}rotateRight(){const t=this.left;return this.left=t.right,t.right=this,this.height=Math.max(this.leftHeight,this.rightHeight)+1,t.height=Math.max(t.leftHeight,this.height)+1,t}rotateLeft(){const t=this.right;return this.right=t.left,t.left=this,this.height=Math.max(this.leftHeight,this.rightHeight)+1,t.height=Math.max(t.rightHeight,this.height)+1,t}get leftHeight(){return null===this.left?-1:this.left.height||0}get rightHeight(){return null===this.right?-1:this.right.height||0}executeOnEveryNode(t){this.left&&this.left.executeOnEveryNode(t),t(this),this.right&&this.right.executeOnEveryNode(t)}betweenBounds(t,e,r){let i=[];return this.hasOwnProperty("key")?(e=e||this.getLowerBoundMatcher(t),r=r||this.getUpperBoundMatcher(t),e(this.key)&&this.left&&(i=i.concat(this.left.betweenBounds(t,e,r))),e(this.key)&&r(this.key)&&this.value&&(i=i.concat(this.value)),r(this.key)&&this.right&&(i=i.concat(this.right.betweenBounds(t,e,r))),i):[]}getLowerBoundMatcher(t){return t.hasOwnProperty("$gt")||t.hasOwnProperty("$gte")?t.hasOwnProperty("$gt")&&t.hasOwnProperty("$gte")?0===this.compareKeys(t.$gte,t.$gt)?e=>this.compareKeys(e,t.$gt)>0:this.compareKeys(t.$gte,t.$gt)>0?e=>this.compareKeys(e,t.$gte)>=0:e=>this.compareKeys(e,t.$gt)>0:t.hasOwnProperty("$gt")?e=>this.compareKeys(e,t.$gt)>0:e=>this.compareKeys(e,t.$gte)>=0:()=>!0}getUpperBoundMatcher(t){return t.hasOwnProperty("$lt")||t.hasOwnProperty("$lte")?t.hasOwnProperty("$lt")&&t.hasOwnProperty("$lte")?0===this.compareKeys(t.$lte,t.$lt)?e=>this.compareKeys(e,t.$lt)<0:this.compareKeys(t.$lte,t.$lt)<0?e=>this.compareKeys(e,t.$lte)<=0:e=>this.compareKeys(e,t.$lt)<0:t.hasOwnProperty("$lt")?e=>this.compareKeys(e,t.$lt)<0:e=>this.compareKeys(e,t.$lte)<=0:()=>!0}compareKeys(t,e){return t>e?1:t<e?-1:0}numberOfKeys(){let t=1;return this.left&&(t+=this.left.numberOfKeys()),this.right&&(t+=this.right.numberOfKeys()),t}}class N{constructor(t,e,r=!1){this._root=null,this._size=0,this.unique=!1,this.fieldName="",this._compare=e||this._defaultCompare,this.unique=r,this.fieldName=t}_defaultCompare(t,e){return t>e?1:t<e?-1:0}insert(t,e){this._root=this._insert(t,e,this._root),this._size++}_insert(t,e,r){if(null===r)return new j(t,e);if(this._compare(t,r.key)<0)r.left=this._insert(t,e,r.left);else{if(!(this._compare(t,r.key)>0)){if(this.unique){this.size>0&&this._size--;const e=new Error(`Can't insert key ${t}, it violates the unique constraint`);throw e.key=t,e.prop=this.fieldName,e.errorType="uniqueViolated",e}return r.value.push(e),r}r.right=this._insert(t,e,r.right)}r.height=Math.max(r.leftHeight,r.rightHeight)+1;const i=this._getBalanceState(r);if(4===i){if(!(this._compare(t,r.left.key)<0))return r.left=r.left.rotateLeft(),r.rotateRight();r=r.rotateRight()}if(0===i){if(!(this._compare(t,r.right.key)>0))return r.right=r.right.rotateRight(),r.rotateLeft();r=r.rotateLeft()}return r}delete(t,e){this._root=this._delete(t,e,this._root),this.size>0&&this._size--}_delete(t,e,r){if(null===r)return this._size++,r;if(this._compare(t,r.key)<0)r.left=this._delete(t,e,r.left);else if(this._compare(t,r.key)>0)r.right=this._delete(t,e,r.right);else{if(r.value.length>1)return r.value.splice(r.value.indexOf(e),1),r;if(r.left||r.right)if(!r.left&&r.right)r=r.right;else if(r.left&&!r.right)r=r.left;else{const t=this._minValueNode(r.right);r.key=t.key,r.value=t.value,r.right=this._delete(t.key,e,r.right)}else r=null}if(null===r)return r;r.height=Math.max(r.leftHeight,r.rightHeight)+1;const i=this._getBalanceState(r);return 4===i?(2===this._getBalanceState(r.left)||3===this._getBalanceState(r.left)||(r.left=r.left.rotateLeft()),r.rotateRight()):0===i?(2===this._getBalanceState(r.right)||1===this._getBalanceState(r.right)||(r.right=r.right.rotateRight()),r.rotateLeft()):r}get(t){if(null===this._root)return[];const e=this._get(t,this._root);return null===e?[]:e.value?e.value:[]}_get(t,e){const r=this._compare(t,e.key);return 0===r?e:r<0?e.left?this._get(t,e.left):null:e.right?this._get(t,e.right):null}contains(t){return null!==this._root&&!!this._get(t,this._root)}findMinimum(){return null===this._root?null:this._minValueNode(this._root).key}findMaximum(){return null===this._root?null:this._maxValueNode(this._root).key}get numberOfKeys(){var t;return(null===(t=this._root)||void 0===t?void 0:t.numberOfKeys())||0}get size(){return this._size}get isEmpty(){return 0===this._size}_minValueNode(t){let e=t;for(;e.left;)e=e.left;return e}_maxValueNode(t){let e=t;for(;e.right;)e=e.right;return e}_getBalanceState(t){switch(t.leftHeight-t.rightHeight){case-2:return 0;case-1:return 1;case 1:return 3;case 2:return 4;default:return 2}}executeOnEveryNode(t){if(this._root)return this._root.executeOnEveryNode(t)}betweenBounds(t,e,r){return this._root?this._root.betweenBounds(t,e,r):[]}}function I(t){return Array.from(new Set(t.map((t=>{return null===(e=t)?"$NU":"string"==typeof e?"$ST"+e:"boolean"==typeof e?"$BO"+e:"number"==typeof e?"$NO"+e:e instanceof Date?"$DA"+e.getTime():e;var e})))).map((t=>"string"==typeof t?t.substr(3):t))}class S{constructor({fieldName:t,unique:e,sparse:r}){this.fieldName="",this.unique=!1,this.sparse=!1,t&&(this.fieldName=t),e&&(this.unique=e),r&&(this.sparse=r),this.tree=new N(this.fieldName,y,this.unique)}reset(){this.tree=new N(this.fieldName,y,this.unique)}insert(t){if(Array.isArray(t))return void this.insertMultipleDocs(t);let e=v(t,this.fieldName);if(void 0!==e||!this.sparse)if(Array.isArray(e)){let r,i=I(e),n=-1;for(let e=0;e<i.length;e++)try{this.tree.insert(i[e],t)}catch(t){r=t,n=e;break}if(r){for(let e=0;e<n;e++)this.tree.delete(i[e],t);throw r}}else this.tree.insert(e,t)}insertMultipleDocs(t){let e,r=-1;for(let i=0;i<t.length;i++)try{this.insert(t[i])}catch(t){e=t,r=i;break}if(e){for(let e=0;e<r;e++)this.remove(t[e]);throw e}}remove(t){if(Array.isArray(t))return void t.forEach((t=>this.remove(t)));let e=v(t,this.fieldName);void 0===e&&this.sparse||(Array.isArray(e)?I(e).forEach((e=>this.tree.delete(e,t))):this.tree.delete(e,t))}update(t,e){if(Array.isArray(t))this.updateMultipleDocs(t);else if(e){this.remove(t);try{this.insert(e)}catch(e){throw this.insert(t),e}}}updateMultipleDocs(t){let e,r=-1;for(let e=0;e<t.length;e++)this.remove(t[e].oldDoc);for(let i=0;i<t.length;i++)try{this.insert(t[i].newDoc)}catch(t){e=t,r=i;break}if(e){for(let e=0;e<r;e++)this.remove(t[e].newDoc);for(let e=0;e<t.length;e++)this.insert(t[e].oldDoc);throw e}}revertUpdate(t,e){var r=[];!Array.isArray(t)&&e?this.update(e,t):Array.isArray(t)&&(t.forEach((t=>{r.push({oldDoc:t.newDoc,newDoc:t.oldDoc})})),this.update(r))}getMatching(t){if(Array.isArray(t)){let e=[];return t.forEach((t=>{this.tree.get(t).forEach((t=>{t&&t._id&&e.push(t)}))})),e.filter(((t,r)=>e.indexOf(t)===r))}return this.tree.get(t)}getAll(){let t=[];return this.tree.executeOnEveryNode((function(e){t=t.concat(e.value)})),t}getBetweenBounds(t){return this.tree.betweenBounds(t)}}class M{constructor(t){const e=indexedDB.open(t);e.onupgradeneeded=()=>e.result.createObjectStore(t);const r=this.pr(e);this.store=(e,i)=>r.then((r=>i(r.transaction(t,e).objectStore(t))))}pr(t){return new Promise(((e,r)=>{t.oncomplete=t.onsuccess=()=>e(t.result),t.onabort=t.onerror=()=>r(t.error)}))}get(t){return this.store("readonly",(e=>this.pr(e.get(t))))}set(t,e){return this.store("readwrite",(r=>(r.put(e,t),this.pr(r.transaction))))}sets(t){return this.store("readwrite",(e=>(t.forEach((t=>e.put(t[1],t[0]))),this.pr(e.transaction))))}gets(t){return this.store("readonly",(e=>Promise.all(t.map((t=>this.pr(e.get(t)))))))}del(t){return this.store("readwrite",(e=>(e.delete(t),this.pr(e.transaction))))}dels(t){return this.store("readwrite",(e=>(t.forEach((t=>e.delete(t))),this.pr(e.transaction))))}clear(){return this.store("readwrite",(t=>(t.clear(),this.pr(t.transaction))))}eachCursor(t,e){return t.openCursor().onsuccess=function(){this.result&&(e(this.result),this.result.continue())},this.pr(t.transaction)}keys(){return this.store("readonly",(t=>O(this,void 0,void 0,(function*(){if(t.getAllKeys)return this.pr(t.getAllKeys());const e=[];return yield this.eachCursor(t,(t=>e.push(t.key))),e}))))}values(){return this.store("readonly",(t=>O(this,void 0,void 0,(function*(){if(t.getAll)return this.pr(t.getAll());const e=[];return yield this.eachCursor(t,(t=>e.push(t.value))),e}))))}length(){return O(this,void 0,void 0,(function*(){return(yield this.keys()).length}))}}const T=(t,e)=>t>e?1:-1;class C{constructor(t,e){this.p=t,this.rdata=e}setLocalHash(t){return O(this,void 0,void 0,(function*(){t||(t=yield this.p.data.keys());const e=n(JSON.stringify(t.sort(T))).toString();this.p.data.set("$H","$H"+e+"_"+this.timeSignature())}))}setRemoteHash(t){return O(this,void 0,void 0,(function*(){t||(t=yield this.rdata.keys());const e=n(JSON.stringify(t.sort(T))).toString();this.rdata.setItem("$H","$H"+e+"_"+this.timeSignature())}))}timeSignature(){return Math.floor(Date.now()/this.p.devalidateHash)}sync(){return new Promise(((t,e)=>{let r=setInterval((()=>O(this,void 0,void 0,(function*(){if(!this.p.syncInProgress){clearInterval(r),this.p.syncInProgress=!0;let i,n={sent:0,received:0,diff:-1};try{n=yield this._sync()}catch(t){i=Error(t)}this.p.syncInProgress=!1,i?e(i):t(n)}}))),1)}))}brace(t,e,r,i){return O(this,void 0,void 0,(function*(){const n=t.split("_")[0],s=t.split("_")[1],o=Number(s.substring(2)),a=i.findIndex((t=>t.key.startsWith(n+"_")));if(a>-1){const n=i[a].key.split("_")[1];o>Number(n.substring(2))&&(i.splice(a,1),r.push({key:t,value:(yield e(t))||""}))}else r.push({key:t,value:(yield e(t))||""});return{thisDiffs:r,thatDiffs:i}}))}causesUCV(t){let e=this.p.treatSingleLine(t);if("remove"===e.status)return!1;try{"doc"===e.type?(e.data._id=null,this.p.db.addToIndexes(e.data)):(this.p.db.indexes[e.data.fieldName]=new S(e.data.data),this.p.db.indexes[e.data.fieldName].insert(this.p.db.getAllData()))}catch(t){return"doc"===e.type?{type:"doc",prop:t.prop,value:t.key}:(delete this.p.db.indexes[e.data.fieldName],{type:"index",fieldName:e.data.fieldName,sparse:!!e.data.data.sparse})}return this.p.db.removeFromIndexes(e.data),!1}_sync(){return O(this,void 0,void 0,(function*(){const t=this.timeSignature().toString(),e=(yield this.rdata.getItem("$H"))||"0",r=(yield this.p.data.get("$H"))||"0";if(r.split("_")[1]===t&&(r===e||"0"===r&&(e||"").indexOf("10009")>-1))return{sent:0,received:0,diff:-1};const i=(yield this.rdata.keys()).filter((t=>"$H"!==t)).sort(T),n=(yield this.p.data.keys()).filter((t=>"$H"!==t)).sort(T),s=[],o=[],a=i.length;let l=0;const d=n.length;let u=0;for(;l<a||u<d;){let t=i[l],e=n[u];t!==e?u===d||T(e,t)>0?(l++,yield this.brace(t,(t=>this.rdata.getItem(t)),s,o)):(u++,yield this.brace(e,(t=>this.p.data.get(t)),o,s)):(l++,u++)}if(0===s.length&&0===o.length)return yield this.setLocalHash(),yield this.setRemoteHash(),{sent:0,received:0,diff:0};const c=[],f=[];for(let t=0;t<s.length;t++){const e=s[t],r=this.causesUCV(e.value);if(r&&"doc"===r.type){const t=r.prop;yield this.p.data.set(n.find((e=>e.startsWith(t+"_")))||"",this.p.encode(h({$$indexCreated:{fieldName:t,unique:!1,sparse:this.p.db.indexes[t].sparse}})))}else r&&"index"===r.type&&(e.value=this.p.encode(h({$$indexCreated:{fieldName:r.fieldName,unique:!1,sparse:r.sparse}})));const i=n.find((t=>t.toString().startsWith(e.key.split("_")[0]+"_")))||"";i&&c.push(i),f.push([e.key,e.value])}yield this.p.data.dels(c),yield this.p.data.sets(f),yield this.setLocalHash();const y=[],p=[];for(let t=0;t<o.length;t++){const e=o[t],r=i.find((t=>t.toString().startsWith(e.key.split("_")[0]+"_")))||"";r&&y.push(r),p.push({key:e.key,value:e.value})}return yield this.rdata.removeItems(y),yield this.rdata.setItems(p),yield this.setRemoteHash(),yield this.p.loadDatabase(),{sent:o.length,received:s.length,diff:1}}))}}class P{constructor(){this.callbacks={readLine:[],writeLine:[],end:[]}}on(t,e){this.callbacks[t]||(this.callbacks[t]=[]),this.callbacks[t].push(e)}emit(t,e){return O(this,void 0,void 0,(function*(){let r=this.callbacks[t];if(r)for(let t=0;t<r.length;t++){const i=r[t];yield i(e)}}))}}class H{constructor(t){if(this.ref="",this.syncInterval=0,this.syncInProgress=!1,this.devalidateHash=0,this.corruptAlertThreshold=.1,this.encode=t=>t,this.decode=t=>t,this._model=t.model,this.db=t.db,this.ref=this.db.ref,this.data=new M(this.ref),this.RSA=t.syncToRemote,this.devalidateHash=t.devalidateHash||0,this.syncInterval=t.syncInterval||0,this.RSA){const t=this.RSA(this.ref);this.sync=new C(this,t)}if(this.RSA&&this.syncInterval&&setInterval((()=>O(this,void 0,void 0,(function*(){if(!this.syncInProgress){let t;this.syncInProgress=!0;try{yield this.sync._sync()}catch(e){t=e}if(this.syncInProgress=!1,t)throw new Error(t)}}))),this.syncInterval),this.corruptAlertThreshold=void 0!==t.corruptAlertThreshold?t.corruptAlertThreshold:.1,t.encode&&!t.decode)throw new Error("encode hook defined but decode hook undefined, cautiously refusing to start Datastore to prevent dataloss");if(!t.encode&&t.decode)throw new Error("decode hook defined but encode hook undefined, cautiously refusing to start Datastore to prevent dataloss");this.encode=t.encode||this.encode,this.decode=t.decode||this.decode;let e=i(113);if(this.decode(this.encode(e))!==e)throw new Error("encode is not the reverse of decode, cautiously refusing to start data store to prevent dataloss")}writeNewIndex(t){return O(this,void 0,void 0,(function*(){yield this.writeData(t.map((t=>[t.$$indexCreated.fieldName,this.encode(h(t))])))}))}writeNewData(t){return O(this,void 0,void 0,(function*(){yield this.writeData(t.map((t=>[t._id||"",this.encode(h(t))])))}))}treatSingleLine(t){let e;try{e=l(this.decode(t)),this._model&&(e=this._model.new(e))}catch(t){return{type:"corrupt",status:"remove",data:!1}}return!e._id||e.$$indexCreated||e.$$indexRemoved?e.$$indexCreated&&void 0!==e.$$indexCreated.fieldName?{type:"index",status:"add",data:{fieldName:e.$$indexCreated.fieldName,data:e.$$indexCreated}}:"string"==typeof e.$$indexRemoved?{type:"index",status:"remove",data:{fieldName:e.$$indexRemoved}}:{type:"corrupt",status:"remove",data:!0}:!0===e.$$deleted?{type:"doc",status:"remove",data:{_id:e._id}}:{type:"doc",status:"add",data:e}}loadDatabase(){return O(this,void 0,void 0,(function*(){this.db.q.pause(),this.db.resetIndexes(!0);let t=0,e=0;const r=[],i=[],n=new P;n.on("readLine",(n=>O(this,void 0,void 0,(function*(){e++;const s=this.treatSingleLine(n);"doc"===s.type?i.push(s):"index"===s.type?r.push(s):s.data||t++})))),yield this.readData(n);for(let t=0;t<r.length;t++){const e=r[t];"add"===e.status&&(this.db.indexes[e.data.fieldName]=new S(e.data.data)),"remove"===e.status&&delete this.db.indexes[e.data.fieldName]}for(let t=0;t<i.length;t++){const e=i[t];"add"===e.status&&this.db.addToIndexes(e.data),"remove"===e.status&&this.db.removeFromIndexes(e.data)}if(e>0&&t/e>this.corruptAlertThreshold)throw new Error(`More than ${Math.floor(100*this.corruptAlertThreshold)}% of the data file is corrupt, the wrong decode hook might have been used. Cautiously refusing to start Datastore to prevent dataloss`);return this.db.q.start(),!0}))}readData(t){return O(this,void 0,void 0,(function*(){const e=yield this.data.values();for(let r=0;r<e.length;r++){const i=e[r];i.startsWith("$H")||"$deleted"===i||t.emit("readLine",i)}t.emit("end","")}))}deleteData(t){return O(this,void 0,void 0,(function*(){if(!this.RSA)return this.data.dels(t);const e=yield this.data.keys(),r=[],i=[];for(let n=0;n<t.length;n++){const s=t[n],o=e.find((t=>t.toString().startsWith(s+"_")))||"",a=Math.random().toString(36).substring(2,4)+Date.now(),h=s+"_"+a;r.push(o),i.push(h),e.splice(e.indexOf(o),1),e.push(h)}yield this.data.dels(r),yield this.data.sets(i.map((t=>[t,"$deleted"]))),this.sync&&(yield this.sync.setLocalHash(e))}))}writeData(t){return O(this,void 0,void 0,(function*(){if(!this.RSA)return this.data.sets(t);const e=yield this.data.keys(),r=[],i=[];for(let n=0;n<t.length;n++){const s=t[n],o=e.find((t=>t.toString().startsWith(s[0]+"_")))||"",a=Math.random().toString(36).substring(2,4)+Date.now(),h=s[0]+"_"+a;r.push(o),i.push([h,s[1]]),e.splice(e.indexOf(o),1),e.push(h)}yield this.data.dels(r),yield this.data.sets(i),this.sync&&(yield this.sync.setLocalHash(e))}))}deleteEverything(){return O(this,void 0,void 0,(function*(){yield this.data.clear()}))}}class q{constructor(){this._id=r()}static new(t){const e=new this,r=Object.keys(t);for(let i=0;i<r.length;i++){const n=r[i];e[n]=t[n]}return e}}class K{constructor(t=1){this._queue=[],this._pause=!1,this._ongoingCount=0,this._concurrency=1,this._resolveEmpty=()=>Promise.resolve(),this._concurrency=t}pause(){this._pause=!0}start(){this._pause=!1,this._next()}add(t){return new Promise(((e,r)=>{const i=()=>O(this,void 0,void 0,(function*(){this._ongoingCount++;try{const r=yield Promise.resolve().then(t);return this._ongoingCount--,this._next(),e(r),r}catch(t){return this._ongoingCount--,this._next(),r(t),null}}));this._ongoingCount<this._concurrency&&!this._pause?i():this._queue.push(i)}))}get waitingCount(){return this._queue.length}get ongoingCount(){return this._ongoingCount}_next(){if(!(this._ongoingCount>=this._concurrency||this._pause))if(this._queue.length>0){const t=this._queue.shift();t&&t()}else this._resolveEmpty()}}class B{constructor(t){this.ref="db",this.timestampData=!1,this.q=new K(1),this.indexes={_id:new S({fieldName:"_id",unique:!0})},this.ttlIndexes={},this.model=t.model||q,t.ref&&(this.ref=t.ref),this.persistence=new H({db:this,model:t.model,encode:t.encode,decode:t.decode,corruptAlertThreshold:t.corruptAlertThreshold||0,syncToRemote:t.syncToRemote,syncInterval:t.syncInterval,devalidateHash:t.devalidateHash}),t.timestampData&&(this.timestampData=!0)}loadDatabase(){return O(this,void 0,void 0,(function*(){return yield this.persistence.loadDatabase()}))}getAllData(){return this.indexes._id.getAll()}resetIndexes(t=!1){Object.keys(this.indexes).forEach((e=>{if(t&&"_id"!==e)return delete this.indexes[e];this.indexes[e].reset()}))}ensureIndex(t){return O(this,void 0,void 0,(function*(){if(!(t=t||{}).fieldName){let t=new Error("Cannot create an index without a fieldName");throw t.missingFieldName=!0,t}if(this.indexes[t.fieldName])return{affectedIndex:t.fieldName};this.indexes[t.fieldName]=new S(t),void 0!==t.expireAfterSeconds&&(this.ttlIndexes[t.fieldName]=t.expireAfterSeconds);try{this.indexes[t.fieldName].insert(this.getAllData())}catch(e){throw delete this.indexes[t.fieldName],e}return yield this.persistence.writeNewIndex([{$$indexCreated:t}]),{affectedIndex:t.fieldName}}))}removeIndex(t){return O(this,void 0,void 0,(function*(){return delete this.indexes[t],yield this.persistence.deleteData([t]),{affectedIndex:t}}))}addToIndexes(t){let e,r=-1;const i=Object.keys(this.indexes);for(let n=0;n<i.length;n++)try{this.indexes[i[n]].insert(t)}catch(t){r=n,e=t;break}if(e){for(let e=0;e<r;e++)this.indexes[i[e]].remove(t);throw e}}removeFromIndexes(t){Object.keys(this.indexes).forEach((e=>{this.indexes[e].remove(t)}))}updateIndexes(t,e){let r,i=-1;const n=Object.keys(this.indexes);for(let s=0;s<n.length;s++)try{this.indexes[n[s]].update(t,e)}catch(t){i=s,r=t;break}if(r){for(let r=0;r<i;r++)this.indexes[n[r]].revertUpdate(t,e);throw r}}_isBasicType(t){return"string"==typeof t||"number"==typeof t||"boolean"==typeof t||t instanceof Date||null===t}_leastCandidates(t){const e=Object.keys(this.indexes),r=Object.keys(t);let i=[];return r.forEach((r=>{this._isBasicType(t[r])&&-1!==e.indexOf(r)&&i.push(r)})),i.length>0?this.indexes[i[0]].getMatching(t[i[0]]):(r.forEach((r=>{t[r]&&t[r].hasOwnProperty("$eq")&&this._isBasicType(t[r].$eq)&&-1!==e.indexOf(r)&&i.push(r)})),i.length>0?this.indexes[i[0]].getMatching(t[i[0]].$eq):(r.forEach((r=>{t[r]&&t[r].hasOwnProperty("$in")&&-1!==e.indexOf(r)&&i.push(r)})),i.length>0?this.indexes[i[0]].getMatching(t[i[0]].$in):(r.forEach((r=>{t[r]&&-1!==e.indexOf(r)&&(t[r].hasOwnProperty("$lt")||t[r].hasOwnProperty("$lte")||t[r].hasOwnProperty("$gt")||t[r].hasOwnProperty("$gte"))&&i.push(r)})),i.length>0?this.indexes[i[0]].getBetweenBounds(t[i[0]]):this.getAllData())))}getCandidates(t,e){return O(this,void 0,void 0,(function*(){let r=this._leastCandidates(t);if(e)return Array.isArray(r)?r:null===r?[]:[r];const i=[],n=[],s=Object.keys(this.ttlIndexes);if(!r)return[];Array.isArray(r)||(r=[r]),r.forEach((t=>{let e=!0;s.forEach((r=>{void 0!==t[r]&&t[r]instanceof Date&&Date.now()>t[r].getTime()+1e3*this.ttlIndexes[r]&&(e=!1)})),e?n.push(t):t._id&&i.push(t._id)}));for(let t=0;t<i.length;t++){const e=i[t];yield this._remove({_id:e},{multi:!1})}return n}))}_insert(t){return O(this,void 0,void 0,(function*(){let e=this.prepareDocumentForInsertion(t);return this._insertInCache(e),yield this.persistence.writeNewData(Array.isArray(e)?e:[e]),d(e,this.model)}))}createNewId(){let t=r();return this.indexes._id.getMatching(t).length>0&&(t=this.createNewId()),t}prepareDocumentForInsertion(t){let e=[];if(Array.isArray(t))t.forEach((t=>{e.push(this.prepareDocumentForInsertion(t))}));else{e=d(t,this.model),void 0===e._id&&(e._id=this.createNewId());const r=new Date;this.timestampData&&void 0===e.createdAt&&(e.createdAt=r),this.timestampData&&void 0===e.updatedAt&&(e.updatedAt=r),a(e)}return e}_insertInCache(t){Array.isArray(t)?this._insertMultipleDocsInCache(t):this.addToIndexes(t)}_insertMultipleDocsInCache(t){let e,r=-1;for(let i=0;i<t.length;i++)try{this.addToIndexes(t[i])}catch(t){e=t,r=i;break}if(e){for(let e=0;e<r;e++)this.removeFromIndexes(t[e]);throw e}}insert(t){return O(this,void 0,void 0,(function*(){const e=yield this.q.add((()=>this._insert(t)));return Array.isArray(e)?{docs:e,number:e.length}:{docs:[e],number:1}}))}count(t){return O(this,void 0,void 0,(function*(){const e=new D(this,t);return(yield e.exec()).length}))}find(t){return O(this,void 0,void 0,(function*(){const e=new D(this,t);return yield e.exec()}))}cursor(t){return new D(this,t)}_update(t,e,r){return O(this,void 0,void 0,(function*(){let i=void 0!==r.multi&&r.multi,n=void 0!==r.upsert&&r.upsert;const s=new D(this,t);s.limit(1);const o=yield s.__exec_unsafe();if(o.length>0){let r=0;const n=yield this.getCandidates(t),s=[];for(let o=0;o<n.length;o++)if((i||0===r)&&A(n[o],t)){r++;let t=n[o].createdAt,i=m(n[o],e,this.model);t&&(i.createdAt=t),!this.timestampData||void 0!==e.updatedAt||e.$set&&void 0!==e.$set.updatedAt||(i.updatedAt=new Date),s.push({oldDoc:n[o],newDoc:i})}this.updateIndexes(s);const o=s.map((t=>t.newDoc));return yield this.persistence.writeNewData(o),{number:o.length,docs:o.map((t=>d(t,this.model))),upsert:!1}}if(0===o.length&&n){if(!e.$setOnInsert)throw new Error("$setOnInsert modifier is required when upserting");let t=d(e.$setOnInsert,this.model,!0);const r=yield this._insert(t);return Array.isArray(r)?{number:r.length,docs:r,upsert:!0}:{number:1,docs:[r],upsert:!0}}return{number:0,docs:[],upsert:!1}}))}update(t,e,r){return O(this,void 0,void 0,(function*(){return yield this.q.add((()=>this._update(t,e,r)))}))}_remove(t,e){return O(this,void 0,void 0,(function*(){let r=0;const i=[],n=[];let s=!!e&&!!e.multi;return(yield this.getCandidates(t,!0)).forEach((e=>{A(e,t)&&(s||0===r)&&(r++,n.push(d(e,this.model)),i.push({$$deleted:!0,_id:e._id}),this.removeFromIndexes(e))})),yield this.persistence.deleteData(i.map((t=>t._id||""))),{number:r,docs:n}}))}remove(t,e){return O(this,void 0,void 0,(function*(){return this.q.add((()=>this._remove(t,e)))}))}}const R={};function L(t,e="GET",r="",i,n=!0){return O(this,void 0,void 0,(function*(){return new Promise((s=>{var o=new XMLHttpRequest;o.addEventListener("readystatechange",(function(){if(4===this.readyState){if(!1===n)return s(this.responseText);try{let t=JSON.parse(this.responseText);s(t)}catch(t){s(this.responseText)}}})),o.open(e,(t.endpoint+"/"+r).replace(/(https?:\/{2}.*)\/{2}/,"$1/").replace(/\/$/,"")),o.setRequestHeader("Authorization",`Bearer ${t.token}`),o.setRequestHeader("Content-Type","application/json"),o.send(i)}))}))}class F{constructor({name:t,token:e,endpoint:r}){this.id="",this.name=t,this.token=e,this.endpoint=r,this.connect()}connect(){return O(this,void 0,void 0,(function*(){if(R[this.endpoint]||(R[this.endpoint]={}),R[this.endpoint][this.name])return void(this.id=R[this.endpoint][this.name]);const t=yield this.listStores();for(let e=0;e<t.length;e++){const r=t[e];R[this.endpoint][r.name]=r.id}if(R[this.endpoint][this.name])return void(this.id=R[this.endpoint][this.name]);const e=yield this.createStore(this.name);R[this.endpoint][this.name]=e,this.id=e}))}listStores(){return O(this,void 0,void 0,(function*(){const t=[];let e=1,r=1;for(;r>=e;){const i=yield L(this,"GET",`?page=${e}`);if("string"==typeof i||!i.success||!Array.isArray(i.result))throw new Error("Error while listing namespaces: "+JSON.stringify(i));{const n=i.result;for(let e=0;e<n.length;e++){const r=n[e];t.push({id:r.id,name:r.title})}r=i.result_info.total_pages,e++}}return t}))}createStore(t){return O(this,void 0,void 0,(function*(){const e=yield L(this,"POST","",JSON.stringify({title:t}));if("string"==typeof e||!e.success||Array.isArray(e.result))throw new Error("Error while creating namespace: "+JSON.stringify(e));return e.result.id}))}removeStore(){return O(this,void 0,void 0,(function*(){this.id||(yield this.connect());const t=yield L(this,"DELETE",this.id);if("string"!=typeof t&&t.success)return!0;throw new Error("Error while deleting namespace: "+JSON.stringify(t))}))}removeItem(t){return O(this,void 0,void 0,(function*(){this.id||(yield this.connect());const e=yield L(this,"DELETE",`${this.id}/values/${t}`);if("string"!=typeof e&&e.success)return!0;throw new Error("Error while deleting item: "+JSON.stringify(e))}))}setItem(t,e){return O(this,void 0,void 0,(function*(){this.id||(yield this.connect());const r=yield L(this,"PUT",`${this.id}/values/${t}`,e);if("string"!=typeof r&&r.success)return!0;throw new Error("Error while setting item: "+JSON.stringify(r))}))}getItem(t){return O(this,void 0,void 0,(function*(){this.id||(yield this.connect());const e=yield L(this,"GET",`${this.id}/values/${t}`,void 0,!1);if("string"!=typeof e)throw new Error("Error while getting item: "+JSON.stringify(e));return e}))}keys(){return O(this,void 0,void 0,(function*(){this.id||(yield this.connect());let t=[],e="";do{const r=yield L(this,"GET",`${this.id}/keys${e?`?cursor=${e}`:""}`);if("string"==typeof r||!r.success||!Array.isArray(r.result))throw new Error("Error while listing keys: "+JSON.stringify(r));{const i=r.result;for(let e=0;e<i.length;e++){const r=i[e];t.push(r.name)}e=r.result_info.cursor}}while(e);return t}))}removeItems(t){return O(this,void 0,void 0,(function*(){this.id||(yield this.connect());const e=t.reduce(((t,e,r)=>{const i=Math.floor(r/9999);return t[i]||(t[i]=[]),t[i].push(e),t}),[]);let r=[];for(let t=0;t<e.length;t++){const i=e[t],n=yield L(this,"DELETE",`${this.id}/bulk`,JSON.stringify(i));if("string"==typeof n||!n.success)throw new Error("Error while deleting item: "+JSON.stringify(n));r.push(!0)}return r}))}setItems(t){return O(this,void 0,void 0,(function*(){this.id||(yield this.connect());const e=t.reduce(((t,e,r)=>{const i=Math.floor(r/9999);return t[i]||(t[i]=[]),t[i].push(e),t}),[]);let r=[];for(let t=0;t<e.length;t++){const i=e[t],n=yield L(this,"PUT",`${this.id}/bulk`,JSON.stringify(i));if("string"==typeof n||!n.success)throw new Error("Error while deleting item: "+JSON.stringify(n));r.push(!0)}return r}))}getItems(t){return O(this,void 0,void 0,(function*(){if(0===t.length)return[];const e=new K(20),r=[];for(let i=0;i<t.length;i++){const n=t[i];r.push(e.add((()=>this.getItem(n))))}const i=yield Promise.all(r),n=[];for(let e=0;e<t.length;e++){let r=t[e],s=i[e];n.push({key:r,value:s})}return n}))}}var z=Object.freeze({__proto__:null,kvAdapter:(t,e)=>r=>new F({endpoint:t,token:e,name:r})});const J="insert",U="update",V="delete",W=Symbol.for("object-observer-meta-key-0");function G(t,e,r){const i={};i[W]=e;for(const n in t)i[n]=tt(t[n],n,e,r);return i}function Y(t,e,r){let i=t.length;const n=new Array(i);n[W]=e;for(let s=0;s<i;s++)n[s]=tt(t[s],s,e,r);return n}function Q(t,e){try{t(e)}catch(r){console.error(`failed to notify listener ${t} with ${e}`,r)}}function X(){const t=this.batches;this.batches=[];for(const[e,r]of t)Q(e,r)}function Z(t,e){let r=t;const i=e.length;do{let t=r.observers,n=t.length;for(;n--;){let i=t[n];if(e.length){let t;0===r.batches.length&&queueMicrotask(X.bind(r));for(const e of r.batches)if(e[0]===i){t=e;break}t||(t=[i,[]],r.batches.push(t)),Array.prototype.push.apply(t[1],e)}}const s=r.parent;if(s){for(let t=0;t<i;t++){const i=e[t];e[t]=new rt(i.type,[r.ownKey,...i.path],i.value,i.oldValue,i.object)}r=s}else r=null}while(r)}function tt(t,e,r,i){return void 0!==i&&i.has(t)?null:"object"!=typeof t||null===t?t:Array.isArray(t)?new st({target:t,ownKey:e,parent:r,visited:i}).proxy:t instanceof Date?t:new nt({target:t,ownKey:e,parent:r,visited:i}).proxy}const et={pop:function(){const t=this[W],e=t.target,r=e.length-1;let i=e.pop();if(i&&"object"==typeof i){const t=i[W];t&&(i=t.detach())}return Z(t,[new rt(V,[r],void 0,i,this)]),i},push:function(){const t=this[W],e=t.target,r=arguments.length,i=new Array(r),n=e.length;for(let e=0;e<r;e++)i[e]=tt(arguments[e],n+e,t);const s=Reflect.apply(e.push,e,i),o=[];for(let t=n,r=e.length;t<r;t++)o[t-n]=new rt(J,[t],e[t],void 0,this);return Z(t,o),s},shift:function(){const t=this[W],e=t.target;let r,i,n,s,o;for(r=e.shift(),r&&"object"==typeof r&&(o=r[W],o&&(r=o.detach())),i=0,n=e.length;i<n;i++)s=e[i],s&&"object"==typeof s&&(o=s[W],o&&(o.ownKey=i));return Z(t,[new rt(V,[0],void 0,r,this)]),r},unshift:function(){const t=this[W],e=t.target,r=arguments.length,i=new Array(r);for(let e=0;e<r;e++)i[e]=tt(arguments[e],e,t);const n=Reflect.apply(e.unshift,e,i);for(let t,r=0,i=e.length;r<i;r++)if(t=e[r],t&&"object"==typeof t){const e=t[W];e&&(e.ownKey=r)}const s=i.length,o=new Array(s);for(let t=0;t<s;t++)o[t]=new rt(J,[t],e[t],void 0,this);return Z(t,o),n},reverse:function(){const t=this[W],e=t.target;let r,i,n;for(e.reverse(),r=0,i=e.length;r<i;r++)if(n=e[r],n&&"object"==typeof n){const t=n[W];t&&(t.ownKey=r)}return Z(t,[new rt("reverse",[],void 0,void 0,this)]),this},sort:function(t){const e=this[W],r=e.target;let i,n,s;for(r.sort(t),i=0,n=r.length;i<n;i++)if(s=r[i],s&&"object"==typeof s){const t=s[W];t&&(t.ownKey=i)}return Z(e,[new rt("shuffle",[],void 0,void 0,this)]),this},fill:function(t,e,r){const i=this[W],n=i.target,s=[],o=n.length,a=n.slice(0);if(e=void 0===e?0:e<0?Math.max(o+e,0):Math.min(e,o),r=void 0===r?o:r<0?Math.max(o+r,0):Math.min(r,o),e<o&&r>e){let o;n.fill(t,e,r);for(let t,h,l=e;l<r;l++)t=n[l],n[l]=tt(t,l,i),l in a?(h=a[l],h&&"object"==typeof h&&(o=h[W],o&&(h=o.detach())),s.push(new rt(U,[l],n[l],h,this))):s.push(new rt(J,[l],n[l],void 0,this));Z(i,s)}return this},copyWithin:function(t,e,r){const i=this[W],n=i.target,s=n.length;t=t<0?Math.max(s+t,0):t,e=void 0===e?0:e<0?Math.max(s+e,0):Math.min(e,s),r=void 0===r?s:r<0?Math.max(s+r,0):Math.min(r,s);const o=Math.min(r-e,s-t);if(t<s&&t!==e&&o>0){const s=n.slice(0),a=[];n.copyWithin(t,e,r);for(let e,r,h,l=t;l<t+o;l++)e=n[l],e&&"object"==typeof e&&(e=tt(e,l,i),n[l]=e),r=s[l],r&&"object"==typeof r&&(h=r[W],h&&(r=h.detach())),"object"!=typeof e&&e===r||a.push(new rt(U,[l],e,r,this));Z(i,a)}return this},splice:function(){const t=this[W],e=t.target,r=arguments.length,i=new Array(r),n=e.length;for(let e=0;e<r;e++)i[e]=tt(arguments[e],e,t);const s=0===r?0:i[0]<0?n+i[0]:i[0],o=r<2?n-s:i[1],a=Math.max(r-2,0),h=Reflect.apply(e.splice,e,i),l=e.length;let d,u,c,f;for(let t,r=0;r<l;r++)t=e[r],t&&"object"==typeof t&&(d=t[W],d&&(d.ownKey=r));for(u=0,c=h.length;u<c;u++)f=h[u],f&&"object"==typeof f&&(d=f[W],d&&(h[u]=d.detach()));const y=[];let p;for(p=0;p<o;p++)p<a?y.push(new rt(U,[s+p],e[s+p],h[p],this)):y.push(new rt(V,[s+p],void 0,h[p],this));for(;p<a;p++)y.push(new rt(J,[s+p],e[s+p],void 0,this));return Z(t,y),h}};class rt{constructor(t,e,r,i,n){this.type=t,this.path=e,this.value=r,this.oldValue=i,this.object=n}}class it{constructor(t,e){this.observers=[],this.batches=[];const{target:r,parent:i,ownKey:n,visited:s=new Set}=t;i&&void 0!==n?(this.parent=i,this.ownKey=n):(this.parent=null,this.ownKey=""),s.add(r);const o=e(r,this,s);s.delete(r),this.revocable=Proxy.revocable(o,this),this.proxy=this.revocable.proxy,this.target=o,this.batches=[]}detach(){return this.parent=null,this.target}set(t,e,r){let i=t[e];if(r!==i){const n=tt(r,e,this);if(t[e]=n,i&&"object"==typeof i){const t=i[W];t&&(i=t.detach())}Z(this,void 0===i?[new rt(J,[e],n,void 0,this.proxy)]:[new rt(U,[e],n,i,this.proxy)])}return!0}deleteProperty(t,e){let r=t[e];if(delete t[e],r&&"object"==typeof r){const t=r[W];t&&(r=t.detach())}return Z(this,[new rt(V,[e],void 0,r,this.proxy)]),!0}}class nt extends it{constructor(t){super(t,G)}}class st extends it{constructor(t){super(t,Y)}get(t,e){return et[e]||t[e]}}function ot(t){const e=t[W]?t:new st({target:t,ownKey:"",parent:null}).proxy;function r(t){return t?Array.isArray(t)?at(e,...t):at(e,t):at(e)}function i(t){!function(t,e){const r=t[W].observers;r.some((t=>t===e))||r.push(e)}(e,t)}return{observe:i,unobserve:r,silently:function(t){return O(this,void 0,void 0,(function*(){const e=yield r();yield t(),e.forEach((t=>i(t)))}))},observable:e}}function at(t,...e){return O(this,void 0,void 0,(function*(){t instanceof Promise&&(t=yield Promise.resolve(t));const r=t[W].observers;let i=r.length;if(!i)return[];if(!e.length)return r.splice(0);let n=[];for(;i;){e.indexOf(r[--i])>=0&&n.concat(r.splice(i,1))}return n}))}function ht(t){const e=Object.assign(t,t.$deep);return delete e.$deep,e}const lt={avl:{AvlTree:N,Node:j},Cursor:D,customUtils:s,Datastore:B,Index:S,modelling:k,Q:K,Persistence:H,PersistenceEvent:P};t.BaseModel=q,t.Database=class{constructor(t){this.reloadBeforeOperations=!1,this.create=this.insert,this.find=this.read,this.number=this.count,this.remove=this.delete,this.ensureIndex=this.createIndex,this.model=t.model||q,this.ref=t.ref,this.reloadBeforeOperations=!!t.reloadBeforeOperations,this._datastore=new B({ref:this.ref,model:this.model,encode:t.encode,decode:t.decode,corruptAlertThreshold:t.corruptAlertThreshold,timestampData:t.timestampData,syncToRemote:t.sync?t.sync.syncToRemote:void 0,syncInterval:t.sync?t.sync.syncInterval:void 0,devalidateHash:t.sync?t.sync.devalidateHash:void 0}),this.loaded=this._datastore.loadDatabase()}reloadFirst(){return O(this,void 0,void 0,(function*(){this.reloadBeforeOperations&&(yield this.reload())}))}insert(t){return O(this,void 0,void 0,(function*(){yield this.reloadFirst();return yield this._datastore.insert(t)}))}live(t={},{skip:e=0,limit:r=0,project:i={},sort:n={},toDB:s=!0,fromDB:o=!0}={}){return O(this,arguments,void 0,(function*(){const t=ot(yield this.read(...arguments));return s&&t.observe((t=>{let e=[];for(let r=0;r<t.length;r++){const i=t[r];if(i.path.length>1||"update"===i.type){let t=i.object[i.path[0]],r=t._id;e.push(this.update({_id:r},{$set:t}))}else if("delete"===i.type){let t=i.oldValue._id;e.push(this.delete({_id:t}))}else if("insert"===i.type){let t=i.value;t._id,e.push(this.insert(t))}}Promise.all(e).catch((t=>{console.error("Applying observable changes on the database failed with error"),console.error(t)}))})),t}))}read(t={},{skip:e=0,limit:r=0,project:i={},sort:n={}}={}){return O(this,void 0,void 0,(function*(){t=ht(t),n=ht(n),i=ht(i);const s=this._datastore.cursor(t);return n&&s.sort(n),e&&s.skip(e),r&&s.limit(r),i&&s.projection(i),yield this.reloadFirst(),yield s.exec()}))}update(t,e,r=!1){return O(this,void 0,void 0,(function*(){t=ht(t||{}),e.$set&&(e.$set=ht(e.$set)),e.$unset&&(e.$unset=ht(e.$unset)),yield this.reloadFirst();return yield this._datastore.update(t,e,{multi:r,upsert:!1})}))}upsert(t,e,r=!1){return O(this,void 0,void 0,(function*(){t=ht(t||{}),e.$set&&(e.$set=ht(e.$set)),e.$unset&&(e.$unset=ht(e.$unset)),yield this.reloadFirst();return yield this._datastore.update(t,e,{multi:r,upsert:!0})}))}count(t={}){return O(this,void 0,void 0,(function*(){return t=ht(t||{}),yield this.reloadFirst(),yield this._datastore.count(t)}))}delete(t,e=!1){return O(this,void 0,void 0,(function*(){t=ht(t||{}),yield this.reloadFirst();return yield this._datastore.remove(t,{multi:e||!1})}))}createIndex(t){return O(this,void 0,void 0,(function*(){return yield this.reloadFirst(),yield this._datastore.ensureIndex(t)}))}removeIndex(t){return O(this,void 0,void 0,(function*(){return yield this.reloadFirst(),yield this._datastore.removeIndex(t)}))}reload(){return O(this,void 0,void 0,(function*(){return yield this._datastore.persistence.loadDatabase(),{}}))}sync(){return O(this,void 0,void 0,(function*(){if(!this._datastore.persistence.sync)throw new Error("Can not perform sync operation unless provided with remote DB adapter");return yield this.reloadFirst(),yield this._datastore.persistence.sync.sync()}))}},t._internal=lt,t.adapters=z,Object.defineProperty(t,"__esModule",{value:!0})}));