!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).xwebdb={})}(this,(function(e){"use strict";const t=[];for(let e=0;e<256;e++)t[e]=(e<16?"0":"")+e.toString(16);function r(){let e=4294967295*Math.random()|0,r=4294967295*Math.random()|0,i=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return t[255&e]+t[e>>8&255]+t[e>>16&255]+t[e>>24&255]+"-"+t[255&r]+t[r>>8&255]+"-"+t[r>>16&15|64]+t[r>>24&255]+"-"+t[63&i|128]+t[i>>8&255]+"-"+t[i>>16&255]+t[i>>24&255]+t[255&n]+t[n>>8&255]+t[n>>16&255]+t[n>>24&255]}function i(e=8){return Array.from(new Uint8Array(120)).map((e=>Math.random().toString(36))).join("").split("0.").join("").substring(0,e)}function n(e,t=0){const r=(new TextEncoder).encode(e),i=2654435761;let n=t+3735928559,s=r.length;for(let e=0;e+4<=s;e+=4){n+=((r[e]|r[e+1]<<8|r[e+2]<<16|r[e+3]<<24)>>>0)*i,n=Math.imul(n,i)}if(3&s){let e=r.slice(s-(3&s)),t=0;for(let r=0;r<e.length;r++)t+=e[r]<<8*r;n+=t*i,n=Math.imul(n,i)}return n^=n>>>15,n=Math.imul(n,i),n^=n>>>13,n=Math.imul(n,i),n^=n>>>16,n>>>0}var s=Object.freeze({__proto__:null,uid:r,randomString:i,xxh:n});function o(e,t=!1){return JSON.stringify(e,(function(e,r){if(t||h(e,r),void 0!==r)return null===r?null:"function"==typeof this[e].getTime?{$$date:this[e].getTime()}:r}))}function a(e){return JSON.parse(e,(function(e,t){if("$$date"===e)return new Date(t);let r=typeof t;return"string"===r||"number"===r||"boolean"===r||null===t?t:t&&t.$$date?t.$$date:t}))}function h(e,t){if("number"==typeof e&&(e=e.toString()),!("$"!==e[0]||"$$date"===e&&"number"==typeof t||"$$deleted"===e&&!0===t||"$$indexCreated"===e||"$$indexRemoved"===e))throw new Error("XWebDB: Field names cannot begin with the $ character");if(-1!==e.indexOf("."))throw new Error("XWebDB: Field names cannot contain a .")}function l(e){if(Array.isArray(e))e.forEach((e=>l(e)));else if(u(e)&&!(e instanceof Date))for(const[t,r]of Object.entries(e))h(t,r),l(r)}function d(e){return!u(e)}function u(e){return!("object"!=typeof e||null===e||e instanceof Date||Array.isArray(e))}function c(e,t,r=!1){let i=typeof e;if("boolean"===i||"number"===i||"string"===i)return e;if(null===e||e instanceof Date)return e;if(Array.isArray(e))return e.map((e=>c(e,t,r)));if("object"==typeof e){let i={};return Object.entries(e).forEach((([e,n])=>{(!r||"$"!==e[0]&&-1===e.indexOf("."))&&(i[e]=c(n,t,r))})),i.hasOwnProperty("_id")?t.new(i):i}return JSON.parse(JSON.stringify({temp:e})).temp}function f(e,t){const r="string"==typeof t?t.split("."):t;if(e){if(0===r.length)return e;if(1===r.length)return e[r[0]];if(Array.isArray(e[r[0]])){let t=parseInt(r[1],10);if("number"==typeof t&&!isNaN(t))return f(e[r[0]][t],r.slice(2));let i=new Array;for(let t=0;t<e[r[0]].length;t+=1)i.push(f(e[r[0]][t],r.slice(1)));return i}return f(e[r[0]],r.slice(1))}}function y(e){const t={};!function e(r,i=""){for(const n in r)if(r.hasOwnProperty(n)){const s=i?`${i}.${n}`:n,o=r[n];!Array.isArray(o)&&"object"==typeof o&&null!==o&&Object.keys(o).length&&-1===Object.keys(o).join("").indexOf("$")?e(o,s):t[s]=o}}(e.$deep);const r=Object.assign(e,t);return delete r.$deep,r}function p(e,t){let r=typeof e,i=typeof t;return null===e||"string"===r||"boolean"===r||"number"===r||null===t||"string"===i||"boolean"===i||"number"===i?e===t:e instanceof Date||t instanceof Date?e instanceof Date&&t instanceof Date&&e.getTime()===t.getTime():!(!(Array.isArray(e)&&Array.isArray(t)||!Array.isArray(e)&&!Array.isArray(t))||void 0===e||void 0===t)&&o({temp:e},!0)===o({temp:t},!0)}function g(e,t){let r=typeof e,i=typeof t;return("string"===r||"number"===r||"string"===i||"number"===i||e instanceof Date||t instanceof Date)&&r===i}function m(e,t){return e<t?-1:e>t?1:0}function v(e,t){if(void 0===e)return void 0===t?0:-1;if(void 0===t)return 1;if(null===e)return null===t?0:-1;if(null===t)return 1;let r=typeof e,i=typeof t;if("number"===r)return"number"==typeof t?m(e,t):-1;if("number"===i)return 1;if("string"===r)return"string"===i?m(e,t):-1;if("string"===i)return 1;if("boolean"===r)return"boolean"===i?m(e,t):-1;if("boolean"===i)return 1;if(e instanceof Date)return t instanceof Date?m(e.getTime(),t.getTime()):-1;if(t instanceof Date)return 1;if(Array.isArray(e))return Array.isArray(t)?function(e,t){for(let r=0;r<Math.min(e.length,t.length);r+=1){let i=v(e[r],t[r]);if(0!==i)return i}return m(e.length,t.length)}(e,t):-1;if(Array.isArray(t))return 1;let n=Object.keys(e).sort(),s=Object.keys(t).sort();for(let r=0;r<Math.min(n.length,s.length);r+=1){let i=v(e[n[r]],t[s[r]]);if(0!==i)return i}return m(n.length,s.length)}const b={$size:function(e,t){if(!Array.isArray(e))return!1;if("number"!=typeof t||t%1!=0)throw new Error("XWebDB: $size operator called without an integer");return e.length===t},$elemMatch:function(e,t){if(!Array.isArray(e))return!1;let r=e.length;for(;r--;)if(D(e[r],t))return!0;return!1},$all:function(e,t){if(!Array.isArray(e))throw new Error("XWebDB: $all must be applied on fields of type array");if(!Array.isArray(t))throw new Error("XWebDB: $all must be supplied with argument of type array");for(let r=0;r<t.length;r++)if(-1===e.indexOf(t[r]))return!1;return!0}},w=Object.assign({$type:function(e,t){return["number","boolean","string","undefined"].indexOf(t)>-1?typeof e===t:"array"===t?Array.isArray(e):"null"===t?null===e:"date"===t?e instanceof Date:"object"===t&&!("object"!=typeof e||e instanceof Date||null===e||Array.isArray(e))},$not:(e,t)=>!D({k:e},{k:t}),$eq:(e,t)=>p(e,t),$lt:(e,t)=>g(e,t)&&e<t,$lte:(e,t)=>g(e,t)&&e<=t,$gt:(e,t)=>g(e,t)&&e>t,$gte:(e,t)=>g(e,t)&&e>=t,$mod:function(e,t){if(!Array.isArray(t))throw new Error("XWebDB: malformed mod, must be supplied with an array");if(2!==t.length)throw new Error("XWebDB: malformed mod, array length must be exactly two, a divisor and a remainder");return e%t[0]===t[1]},$ne:function(e,t){return void 0===e||!p(e,t)},$in:function(e,t){if(!Array.isArray(t))throw new Error("XWebDB: $in operator called with a non-array");for(let r=0;r<t.length;r+=1)if(p(e,t[r]))return!0;return!1},$nin:function(e,t){if(!Array.isArray(t))throw new Error("XWebDB: $nin operator called with a non-array");return!w.$in(e,t)},$regex:function(e,t){if(!(t instanceof RegExp))throw new Error("XWebDB: $regex operator called with non regular expression");return"string"==typeof e&&t.test(e)},$exists:function(e,t){return t=!(!t&&""!==t),void 0===e?!t:t}},b);function _(e,t,r){if(!Array.isArray(r))throw new Error("XWebDB: $or/$nor/$and operators should be used with an array");for(let i=0;i<r.length;i+=1){if(D(t,r[i])){if("$or"===e)return!0;if("$nor"===e)return!1}else if("$and"===e)return!1}return"$or"!==e}const $={$and:(e,t)=>_("$and",e,t),$nor:(e,t)=>_("$nor",e,t),$or:(e,t)=>_("$or",e,t),$where:(e,t)=>{if("function"!=typeof t)throw new Error("XWebDB: $where operator used without a function");let r=t.call(e);if("boolean"!=typeof r)throw new Error("XWebDB: $where function must return boolean");return r}};function D(e,t){let r=!1,i=Object.keys(t);for(let e=0;e<i.length;e++){const t=i[e];if(w[t]){r=!0;break}}if(d(e)||d(t)||r)return x({TMP:e},"TMP",t);for(let r=0;r<i.length;r+=1){let n=i[r],s=t[n];if("$"===n[0]){let t=$[n];if(!t)throw new Error("XWebDB: Unknown logical operator "+n);if(!t(e,s))return!1}else if(!x(e,n,s))return!1}return!0}function x(e,t,r,i){const n=f(e,t);if(Array.isArray(n)&&!i){if(Array.isArray(r))return x(e,t,r,!0);if(null!==r&&"object"==typeof r&&!(r instanceof RegExp)){let i=Object.keys(r);for(let n=0;n<i.length;n+=1)if(b[i[n]])return x(e,t,r,!0)}if(r.$ne&&-1!==n.indexOf(r.$ne))return!1;if(Array.isArray(r.$nin)&&r.$nin.filter((e=>-1!==n.indexOf(e))).length)return!1;for(let e=0;e<n.length;e+=1)if(x({TMP:n[e]},"TMP",r))return!0;return!1}if(!("object"!=typeof r||null===r||r instanceof RegExp||Array.isArray(r))){let e=Object.keys(r),t=e.map((e=>e[0])),i=t.filter((e=>"$"===e));if(0!==i.length&&i.length!==t.length)throw new Error("XWebDB: You cannot mix operators and normal fields");if(i.length>0){for(let t=0;t<e.length;t+=1){if(!w[e[t]])throw new Error("XWebDB: Unknown comparison function "+e[t]);if(!w[e[t]](n,r[e[t]]))return!1}return!0}}return r instanceof RegExp?w.$regex(n,r):!!p(n,r)}const A={$set:function(e,t,r){e&&(e[t]=r)},$mul:function(e,t,r){let i=e[t];if("number"!=typeof r||"number"!=typeof i)throw new Error("XWebDB: Multiply operator works only on numbers");e[t]=i*r},$unset:function(e,t){Array.isArray(e)?e.splice(Number(t),1):delete e[t]},$push:function(e,t,r){if(e.hasOwnProperty(t)||(e[t]=[]),!Array.isArray(e[t]))throw new Error("XWebDB: Can't $push an element on non-array values");if(null!==r&&"object"==typeof r&&r.$slice&&void 0===r.$each&&(r.$each=[]),null!==r&&"object"==typeof r&&r.$each){const i=r.$each,n=r.$slice,s=r.$position,o=r.$sort,a=Object.keys(r);if(a.length>1&&a.filter((e=>-1===["$each","$slice","$position","$sort"].indexOf(e))).length)throw new Error("XWebDB: Can only use the known modifiers $slice, $position and $sort in conjunction with $each when $push to array");if(!Array.isArray(i))throw new Error("XWebDB: $each requires an array value");if(void 0!==n&&"number"!=typeof n)throw new Error("XWebDB: $slice requires a number value");if(s)for(let r=0;r<i.length;r++)e[t].splice(s+r,0,i[r]);else i.forEach((r=>e[t].push(r)));if(o&&("number"==typeof o?1===o?e[t].sort(((e,t)=>v(e,t))):e[t].sort(((e,t)=>v(t,e))):e[t].sort(((e,t)=>{const r=Object.keys(o);for(let i=0;i<r.length;i++){const n=r[i];if(1===o[n]){const r=v(e[n],t[n]);if(r)return r}else{const r=v(t[n],e[n]);if(r)return r}}return 0}))),0===n)e[t]=[];else if("number"==typeof n){let r=0,i=0,s=e[t].length;n<0?(r=Math.max(0,s+n),i=s):n>0&&(r=0,i=Math.min(s,n)),e[t]=e[t].slice(r,i)}}else e[t].push(r)},$addToSet:function(e,t,r){if(e.hasOwnProperty(t)||(e[t]=[]),!Array.isArray(e[t]))throw new Error("XWebDB: Can't $addToSet an element on non-array values");const i=r?r.$each:void 0;if(null!==r&&"object"==typeof r&&i){if(Object.keys(r).length>1)throw new Error("XWebDB: Can't use another field in conjunction with $each on $addToSet modifier");if(!Array.isArray(i))throw new Error("XWebDB: $each requires an array value");i.forEach((r=>A.$addToSet(e,t,r)))}else{let i=!0;for(let n=0;n<e[t].length;n++){if(0===v(e[t][n],r)){i=!1;break}}i&&e[t].push(r)}},$pop:function(e,t,r){if(!Array.isArray(e[t]))throw new Error("XWebDB: Can't $pop an element from non-array values");if("number"!=typeof r||r%1!=0)throw new Error("XWebDB: "+r+" isn't an integer, can't use it with $pop");0!==r&&(e[t]=r>0?e[t].slice(0,e[t].length-1):e[t].slice(1))},$pull:function(e,t,r){if(!Array.isArray(e[t]))throw new Error("XWebDB: Can't $pull an element from non-array values");let i=e[t];for(let e=i.length-1;e>=0;e-=1)D(i[e],r)&&i.splice(e,1)},$pullAll:function(e,t,r){if(!Array.isArray(e[t]))throw new Error("XWebDB: Can't $pull an element from non-array values");let i=e[t];for(let e=i.length-1;e>=0;e-=1)for(let t=0;t<r.length;t++)D(i[e],r[t])&&i.splice(e,1)},$inc:function(e,t,r){if("number"!=typeof r)throw new Error("XWebDB: "+r+" must be a number");if("number"!=typeof e[t]){if(e.hasOwnProperty(t))throw new Error("XWebDB: Can't use the $inc modifier on non-number fields");e[t]=r}else e[t]=e[t]+r},$max:function(e,t,r){(void 0===e[t]||r>e[t])&&(e[t]=r)},$min:function(e,t,r){(void 0===e[t]||r<e[t])&&(e[t]=r)},$currentDate:function(e,t,r){if(!0===r)e[t]=new Date;else if(r.$type&&"timestamp"===r.$type)e[t]=Date.now();else{if(!r.$type||"date"!==r.$type)throw new Error("XWebDB: Malformed $currentDate update query");e[t]=new Date}},$rename:function(e,t,r){if(Array.isArray(e)){let i=Number(r),n=Number(t);e.splice(i,0,e.splice(n,1)[0])}else e[r]=e[t],delete e[t]},$setOnInsert:function(){}},O={},E=Object.keys(A);for(let e=0;e<E.length;e++){const t=E[e];O[t]=(e,r,i)=>{var n="string"==typeof r?r.split("."):r;if(1===n.length)A[t](e,r,i);else{if(void 0===e[n[0]]){if("$unset"===t)return;e[n[0]]={}}let r=n.slice(1).join(".");O[t](e[n[0]],r,i)}}}function k(e,t,r){const i=Object.keys(t),n=i.map((e=>e.charAt(0))),s=n.filter((e=>"$"===e));if(-1!==i.indexOf("_id")&&t._id!==e._id)throw new Error("XWebDB: You cannot change a document's _id");if(0!==s.length&&s.length!==n.length)throw new Error("XWebDB: You cannot mix modifiers and normal fields");let o;if(0===s.length)o=c(t,r),o._id=e._id;else{const n=Array.from(new Set(i));o=c(e,r);for(let e=0;e<n.length;e++){const r=n[e],i=t[r];if(!O[r])throw new Error("XWebDB: Unknown modifier "+r);if("object"!=typeof i)throw new Error("XWebDB: Modifier "+r+"'s query must be an object");const s=Object.keys(i);for(let e=0;e<s.length;e++){const t=s[e];O[r](o,t,i[t])}}}if(l(o),e._id!==o._id)throw new Error("XWebDB: You cannot change a document's _id");return o}var B=Object.freeze({__proto__:null,toDotNotation:y,serialize:o,deserialize:a,clone:c,validateObject:l,isPrimitiveType:d,modify:k,fromDotNotation:f,match:D,compare:v,modifiersKeys:E,equal:p});function N(e,t,r,i){return new(r||(r=Promise))((function(n,s){function o(e){try{h(i.next(e))}catch(e){s(e)}}function a(e){try{h(i.throw(e))}catch(e){s(e)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}h((i=i.apply(e,t||[])).next())}))}class j{constructor(e,t){this.db=e,this._query=t||{}}limit(e){return this._limit=e,this}skip(e){return this._skip=e,this}sort(e){return this._sort=e,this}projection(e){return this._projection=e,this}_project(e){if(void 0===this._projection||0===Object.keys(this._projection).length)return e;let t=[],r=0!==this._projection._id;delete this._projection._id;let i=Object.keys(this._projection),n=i.map((e=>this._projection[e])).sort();if(n[0]!==n[n.length-1])throw new Error("XWebDB: Can't both keep and omit fields except for _id");let s=1===n[0];for(let n=0;n<e.length;n++){const o=e[n];let a={};s?(a={$set:{}},i.forEach((e=>{a.$set[e]=f(o,e),void 0===a.$set[e]&&delete a.$set[e]})),a=k({},a,this.db.model)):(a={$unset:{}},i.forEach((e=>{a.$unset[e]=!0})),a=k(o,a,this.db.model)),r?a._id=o._id:delete a._id,t.push(a)}return t}__exec_unsafe(){return N(this,void 0,void 0,(function*(){let e=[],t=0,r=0;const i=yield this.db.getCandidates(this._query);for(let n=0;n<i.length;n++)if(D(i[n],this._query))if(this._sort)e.push(i[n]);else if(this._skip&&this._skip>r)r++;else if(e.push(i[n]),t++,this._limit&&this._limit<=t)break;if(this._sort){let t=Object.keys(this._sort);const r=[];for(let e=0;e<t.length;e++){let i=t[e];r.push({key:i,direction:this._sort[i]})}e.sort(((e,t)=>{let i,n,s;for(s=0;s<r.length;s++)if(i=r[s],n=i.direction*v(f(e,i.key),f(t,i.key)),0!==n)return n;return 0}));const i=this._limit||e.length,n=this._skip||0;e=e.slice(n,n+i)}return e=this._project(e),e}))}_exec(){return N(this,void 0,void 0,(function*(){return this.db.q.add((()=>this.__exec_unsafe()))}))}exec(){return N(this,void 0,void 0,(function*(){const e=yield this._exec(),t=[];for(let r=0;r<e.length;r++)t.push(c(e[r],this.db.model));return t}))}}class S{constructor(e,t){this.left=null,this.right=null,this.height=null,this.value=[],this.value.push(t),this.key=e}rotateRight(){const e=this.left;return this.left=e.right,e.right=this,this.height=Math.max(this.leftHeight,this.rightHeight)+1,e.height=Math.max(e.leftHeight,this.height)+1,e}rotateLeft(){const e=this.right;return this.right=e.left,e.left=this,this.height=Math.max(this.leftHeight,this.rightHeight)+1,e.height=Math.max(e.rightHeight,this.height)+1,e}get leftHeight(){return null===this.left?-1:this.left.height||0}get rightHeight(){return null===this.right?-1:this.right.height||0}executeOnEveryNode(e){this.left&&this.left.executeOnEveryNode(e),e(this),this.right&&this.right.executeOnEveryNode(e)}betweenBounds(e,t,r){let i=[];return this.hasOwnProperty("key")?(t=t||this.getLowerBoundMatcher(e),r=r||this.getUpperBoundMatcher(e),t(this.key)&&this.left&&(i=i.concat(this.left.betweenBounds(e,t,r))),t(this.key)&&r(this.key)&&this.value&&(i=i.concat(this.value)),r(this.key)&&this.right&&(i=i.concat(this.right.betweenBounds(e,t,r))),i):[]}getLowerBoundMatcher(e){return e.hasOwnProperty("$gt")||e.hasOwnProperty("$gte")?e.hasOwnProperty("$gt")&&e.hasOwnProperty("$gte")?0===this.compareKeys(e.$gte,e.$gt)?t=>this.compareKeys(t,e.$gt)>0:this.compareKeys(e.$gte,e.$gt)>0?t=>this.compareKeys(t,e.$gte)>=0:t=>this.compareKeys(t,e.$gt)>0:e.hasOwnProperty("$gt")?t=>this.compareKeys(t,e.$gt)>0:t=>this.compareKeys(t,e.$gte)>=0:()=>!0}getUpperBoundMatcher(e){return e.hasOwnProperty("$lt")||e.hasOwnProperty("$lte")?e.hasOwnProperty("$lt")&&e.hasOwnProperty("$lte")?0===this.compareKeys(e.$lte,e.$lt)?t=>this.compareKeys(t,e.$lt)<0:this.compareKeys(e.$lte,e.$lt)<0?t=>this.compareKeys(t,e.$lte)<=0:t=>this.compareKeys(t,e.$lt)<0:e.hasOwnProperty("$lt")?t=>this.compareKeys(t,e.$lt)<0:t=>this.compareKeys(t,e.$lte)<=0:()=>!0}compareKeys(e,t){return e>t?1:e<t?-1:0}numberOfKeys(){let e=1;return this.left&&(e+=this.left.numberOfKeys()),this.right&&(e+=this.right.numberOfKeys()),e}}class I{constructor(e,t,r=!1){this._root=null,this._size=0,this.unique=!1,this.fieldName="",this._compare=t||this._defaultCompare,this.unique=r,this.fieldName=e}_defaultCompare(e,t){return e>t?1:e<t?-1:0}insert(e,t){this._root=this._insert(e,t,this._root),this._size++}_insert(e,t,r){if(null===r)return new S(e,t);if(this._compare(e,r.key)<0)r.left=this._insert(e,t,r.left);else{if(!(this._compare(e,r.key)>0)){if(this.unique){this.size>0&&this._size--;const t=new Error(`XWebDB: Can't insert key ${e}, it violates the unique constraint`);throw t.key=e,t.prop=this.fieldName,t.errorType="uniqueViolated",t}return r.value.push(t),r}r.right=this._insert(e,t,r.right)}r.height=Math.max(r.leftHeight,r.rightHeight)+1;const i=this._getBalanceState(r);if(4===i){if(!(this._compare(e,r.left.key)<0))return r.left=r.left.rotateLeft(),r.rotateRight();r=r.rotateRight()}if(0===i){if(!(this._compare(e,r.right.key)>0))return r.right=r.right.rotateRight(),r.rotateLeft();r=r.rotateLeft()}return r}delete(e,t){this._root=this._delete(e,t,this._root),this.size>0&&this._size--}_delete(e,t,r){if(null===r)return this._size++,r;if(this._compare(e,r.key)<0)r.left=this._delete(e,t,r.left);else if(this._compare(e,r.key)>0)r.right=this._delete(e,t,r.right);else{if(r.value.length>1)return r.value.splice(r.value.indexOf(t),1),r;if(r.left||r.right)if(!r.left&&r.right)r=r.right;else if(r.left&&!r.right)r=r.left;else{const e=this._minValueNode(r.right);r.key=e.key,r.value=e.value,r.right=this._delete(e.key,t,r.right)}else r=null}if(null===r)return r;r.height=Math.max(r.leftHeight,r.rightHeight)+1;const i=this._getBalanceState(r);return 4===i?(2===this._getBalanceState(r.left)||3===this._getBalanceState(r.left)||(r.left=r.left.rotateLeft()),r.rotateRight()):0===i?(2===this._getBalanceState(r.right)||1===this._getBalanceState(r.right)||(r.right=r.right.rotateRight()),r.rotateLeft()):r}get(e){if(null===this._root)return[];const t=this._get(e,this._root);return null===t?[]:t.value?t.value:[]}_get(e,t){const r=this._compare(e,t.key);return 0===r?t:r<0?t.left?this._get(e,t.left):null:t.right?this._get(e,t.right):null}contains(e){return null!==this._root&&!!this._get(e,this._root)}findMinimum(){return null===this._root?null:this._minValueNode(this._root).key}findMaximum(){return null===this._root?null:this._maxValueNode(this._root).key}get numberOfKeys(){var e;return(null===(e=this._root)||void 0===e?void 0:e.numberOfKeys())||0}get size(){return this._size}get isEmpty(){return 0===this._size}_minValueNode(e){let t=e;for(;t.left;)t=t.left;return t}_maxValueNode(e){let t=e;for(;t.right;)t=t.right;return t}_getBalanceState(e){switch(e.leftHeight-e.rightHeight){case-2:return 0;case-1:return 1;case 1:return 3;case 2:return 4;default:return 2}}executeOnEveryNode(e){if(this._root)return this._root.executeOnEveryNode(e)}betweenBounds(e,t,r){return this._root?this._root.betweenBounds(e,t,r):[]}}function W(e){return Array.from(new Set(e.map((e=>{return null===(t=e)?"$NU":"string"==typeof t?"$ST"+t:"boolean"==typeof t?"$BO"+t:"number"==typeof t?"$NO"+t:t instanceof Date?"$DA"+t.getTime():t;var t})))).map((e=>"string"==typeof e?e.substr(3):e))}class M{constructor({fieldName:e,unique:t,sparse:r}){this.fieldName="",this.unique=!1,this.sparse=!1,e&&(this.fieldName=e),t&&(this.unique=t),r&&(this.sparse=r),this.tree=new I(this.fieldName,v,this.unique)}reset(){this.tree=new I(this.fieldName,v,this.unique)}insert(e){if(Array.isArray(e))return void this.insertMultipleDocs(e);let t=f(e,this.fieldName);if(void 0!==t||!this.sparse)if(Array.isArray(t)){let r,i=W(t),n=-1;for(let t=0;t<i.length;t++)try{this.tree.insert(i[t],e)}catch(e){r=e,n=t;break}if(r){for(let t=0;t<n;t++)this.tree.delete(i[t],e);throw r}}else this.tree.insert(t,e)}insertMultipleDocs(e){let t,r=-1;for(let i=0;i<e.length;i++)try{this.insert(e[i])}catch(e){t=e,r=i;break}if(t){for(let t=0;t<r;t++)this.remove(e[t]);throw t}}remove(e){if(Array.isArray(e))return void e.forEach((e=>this.remove(e)));let t=f(e,this.fieldName);void 0===t&&this.sparse||(Array.isArray(t)?W(t).forEach((t=>this.tree.delete(t,e))):this.tree.delete(t,e))}update(e,t){if(Array.isArray(e))this.updateMultipleDocs(e);else if(t){this.remove(e);try{this.insert(t)}catch(t){throw this.insert(e),t}}}updateMultipleDocs(e){let t,r=-1;for(let t=0;t<e.length;t++)this.remove(e[t].oldDoc);for(let i=0;i<e.length;i++)try{this.insert(e[i].newDoc)}catch(e){t=e,r=i;break}if(t){for(let t=0;t<r;t++)this.remove(e[t].newDoc);for(let t=0;t<e.length;t++)this.insert(e[t].oldDoc);throw t}}revertUpdate(e,t){var r=[];!Array.isArray(e)&&t?this.update(t,e):Array.isArray(e)&&(e.forEach((e=>{r.push({oldDoc:e.newDoc,newDoc:e.oldDoc})})),this.update(r))}getMatching(e){if(Array.isArray(e)){let t=[];return e.forEach((e=>{this.tree.get(e).forEach((e=>{e&&e._id&&t.push(e)}))})),t.filter(((e,r)=>t.indexOf(e)===r))}return this.tree.get(e)}getAll(){let e=[];return this.tree.executeOnEveryNode((function(t){e=e.concat(t.value)})),e}getBetweenBounds(e){return this.tree.betweenBounds(e)}}class X{constructor(e){const t=indexedDB.open(e);t.onupgradeneeded=()=>t.result.createObjectStore(e);const r=this.pr(t);this.store=(t,i)=>r.then((r=>i(r.transaction(e,t).objectStore(e))))}pr(e){return new Promise(((t,r)=>{e.oncomplete=e.onsuccess=()=>t(e.result),e.onabort=e.onerror=()=>r(e.error)}))}get(e){return this.store("readonly",(t=>this.pr(t.get(e))))}set(e,t){return this.store("readwrite",(r=>(r.put(t,e),this.pr(r.transaction))))}sets(e){return this.store("readwrite",(t=>(e.forEach((e=>t.put(e[1],e[0]))),this.pr(t.transaction))))}gets(e){return this.store("readonly",(t=>Promise.all(e.map((e=>this.pr(t.get(e)))))))}del(e){return this.store("readwrite",(t=>(t.delete(e),this.pr(t.transaction))))}dels(e){return this.store("readwrite",(t=>(e.forEach((e=>t.delete(e))),this.pr(t.transaction))))}clear(){return this.store("readwrite",(e=>(e.clear(),this.pr(e.transaction))))}eachCursor(e,t){return e.openCursor().onsuccess=function(){this.result&&(t(this.result),this.result.continue())},this.pr(e.transaction)}keys(){return this.store("readonly",(e=>N(this,void 0,void 0,(function*(){if(e.getAllKeys)return this.pr(e.getAllKeys());const t=[];return yield this.eachCursor(e,(e=>t.push(e.key))),t}))))}values(){return this.store("readonly",(e=>N(this,void 0,void 0,(function*(){if(e.getAll)return this.pr(e.getAll());const t=[];return yield this.eachCursor(e,(e=>t.push(e.value))),t}))))}length(){return N(this,void 0,void 0,(function*(){return(yield this.keys()).length}))}}const P=[];function T(e){return n(JSON.stringify(e))}function C(){return N(this,void 0,void 0,(function*(){for(let e=0;e<P.length;e++){const t=P[e],r=yield t.database.read(t.queryFilter,t.queryOptions);if(T(r)===T(t.observable.observable))continue;let i=yield t.observable.unobserve(t.toDBObserver);t.observable.observable.splice(0),t.observable.observable.push(...r),i.length&&t.observable.observe(t.toDBObserver)}}))}const q=(e,t)=>e>t?1:-1;class H{constructor(e,t){this.p=e,this.rdata=t}setLocalHash(e){return N(this,void 0,void 0,(function*(){e||(e=yield this.p.data.keys());const t=n(JSON.stringify(e.sort(q))).toString();this.p.data.set("$H","$H"+t+"_"+this.timeSignature())}))}setRemoteHash(e){return N(this,void 0,void 0,(function*(){e||(e=yield this.rdata.keys());const t=n(JSON.stringify(e.sort(q))).toString();this.rdata.setItem("$H","$H"+t+"_"+this.timeSignature())}))}timeSignature(){return Math.floor(Date.now()/this.p.invalidateHash)}sync(){return new Promise(((e,t)=>{let r=setInterval((()=>N(this,void 0,void 0,(function*(){if(!this.p.syncInProgress||this.p.db.deferredDeletes.length+this.p.db.deferredWrites.length){clearInterval(r),this.p.syncInProgress=!0;let i,n={sent:0,received:0,diff:-1};try{n=yield this._sync()}catch(e){i=Error(e)}this.p.syncInProgress=!1,i?t(i):e(n)}}))),1)}))}brace(e,t,r,i){return N(this,void 0,void 0,(function*(){const n=e.split("_")[0],s=e.split("_")[1],o=Number(s.substring(2)),a=i.findIndex((e=>e.key.startsWith(n+"_")));if(a>-1){const n=i[a].key.split("_")[1];o>Number(n.substring(2))&&(i.splice(a,1),r.push({key:e,value:(yield t(e))||""}))}else r.push({key:e,value:(yield t(e))||""});return{thisDiffs:r,thatDiffs:i}}))}causesUCV(e){let t=this.p.treatSingleLine(e);if("remove"===t.status)return!1;try{"doc"===t.type?(t.data._id=null,this.p.db.addToIndexes(t.data)):(this.p.db.indexes[t.data.fieldName]=new M(t.data.data),this.p.db.indexes[t.data.fieldName].insert(this.p.db.getAllData()))}catch(e){return"doc"===t.type?{type:"doc",prop:e.prop,value:e.key}:(delete this.p.db.indexes[t.data.fieldName],{type:"index",fieldName:t.data.fieldName,sparse:!!t.data.data.sparse})}return this.p.db.removeFromIndexes(t.data),!1}_sync(e=!1){return N(this,void 0,void 0,(function*(){const t=this.timeSignature().toString(),r=(yield this.rdata.getItem("$H"))||"0",i=(yield this.p.data.get("$H"))||"0",n=i.split("_")[1];if(!e&&n===t&&(i===r||"0"===i&&(r||"").indexOf("10009")>-1))return{sent:0,received:0,diff:-1};const s=(yield this.rdata.keys()).filter((e=>"$H"!==e)).sort(q),a=(yield this.p.data.keys()).filter((e=>"$H"!==e)).sort(q),h=[],l=[],d=s.length;let u=0;const c=a.length;let f=0;for(;u<d||f<c;){let e=s[u],t=a[f];e!==t?f===c||q(t,e)>0?(u++,yield this.brace(e,(e=>this.rdata.getItem(e)),h,l)):(f++,yield this.brace(t,(e=>this.p.data.get(e)),l,h)):(u++,f++)}if(0===h.length&&0===l.length)return yield this.setLocalHash(),yield this.setRemoteHash(),{sent:0,received:0,diff:0};const y=[],p=[];for(let e=0;e<h.length;e++){const t=h[e],r=this.causesUCV(t.value);if(r&&"doc"===r.type){const e=r.prop;yield this.p.data.set(a.find((t=>t.startsWith(e+"_")))||"",this.p.encode(o({$$indexCreated:{fieldName:e,unique:!1,sparse:this.p.db.indexes[e].sparse}})))}else r&&"index"===r.type&&(t.value=this.p.encode(o({$$indexCreated:{fieldName:r.fieldName,unique:!1,sparse:r.sparse}})));const i=a.find((e=>e.toString().startsWith(t.key.split("_")[0]+"_")))||"";i&&y.push(i),p.push([t.key,t.value])}yield this.p.data.dels(y),yield this.p.data.sets(p),yield this.setLocalHash();const g=[],m=[];for(let e=0;e<l.length;e++){const t=l[e],r=s.find((e=>e.toString().startsWith(t.key.split("_")[0]+"_")))||"";r&&g.push(r),m.push({key:t.key,value:t.value})}yield this.rdata.removeItems(g),yield this.rdata.setItems(m),yield this.setRemoteHash(),yield this.p.loadDatabase();try{C()}catch(e){console.error("XWebDB: Could not do live updates due to an error:",e)}return{sent:l.length,received:h.length,diff:1}}))}}class K{constructor(){this.callbacks={readLine:[],writeLine:[],end:[]}}on(e,t){this.callbacks[e]||(this.callbacks[e]=[]),this.callbacks[e].push(t)}emit(e,t){return N(this,void 0,void 0,(function*(){let r=this.callbacks[e];if(r)for(let e=0;e<r.length;e++){const i=r[e];yield i(t)}}))}}class R{constructor(e){if(this.ref="",this.syncInterval=0,this.syncInProgress=!1,this.invalidateHash=0,this.corruptAlertThreshold=.1,this.encode=e=>e,this.decode=e=>e,this.stripDefaults=!1,this._model=e.model,this.db=e.db,this.ref=this.db.ref,this.stripDefaults=e.stripDefaults,this.data=new X(this.ref),this.RSA=e.syncToRemote,this.invalidateHash=e.invalidateHash||0,this.syncInterval=e.syncInterval||0,this.RSA){const e=this.RSA(this.ref);this.sync=new H(this,e)}if(this.RSA&&this.syncInterval&&setInterval((()=>N(this,void 0,void 0,(function*(){if(!this.syncInProgress){let e;this.syncInProgress=!0;try{yield this.sync._sync()}catch(t){e=t}if(this.syncInProgress=!1,e)throw new Error(e)}}))),this.syncInterval),this.corruptAlertThreshold=void 0!==e.corruptAlertThreshold?e.corruptAlertThreshold:.1,e.encode&&!e.decode)throw new Error("XWebDB: encode hook defined but decode hook undefined, cautiously refusing to start Datastore to prevent dataloss");if(!e.encode&&e.decode)throw new Error("XWebDB: decode hook defined but encode hook undefined, cautiously refusing to start Datastore to prevent dataloss");this.encode=e.encode||this.encode,this.decode=e.decode||this.decode;let t=i(113);if(this.decode(this.encode(t))!==t)throw new Error("XWebDB: encode is not the reverse of decode, cautiously refusing to start data store to prevent dataloss")}writeNewIndex(e){return N(this,void 0,void 0,(function*(){return yield this.writeData(e.map((e=>[e.$$indexCreated.fieldName,this.encode(o(e))])))}))}writeNewData(e){return N(this,void 0,void 0,(function*(){if(this.stripDefaults&&this._model){e=a(o({t:e})).t;for(let t=0;t<e.length;t++)e[t]=this._model.stripDefaults(e[t])}return yield this.writeData(e.map((e=>[e._id||"",this.encode(o(e))])))}))}treatSingleLine(e){let t;try{t=a(this.decode(e)),this._model&&(t=this._model.new(t))}catch(e){return{type:"corrupt",status:"remove",data:!1}}return!t._id||t.$$indexCreated||t.$$indexRemoved?t.$$indexCreated&&void 0!==t.$$indexCreated.fieldName?{type:"index",status:"add",data:{fieldName:t.$$indexCreated.fieldName,data:t.$$indexCreated}}:"string"==typeof t.$$indexRemoved?{type:"index",status:"remove",data:{fieldName:t.$$indexRemoved}}:{type:"corrupt",status:"remove",data:!0}:!0===t.$$deleted?{type:"doc",status:"remove",data:{_id:t._id}}:{type:"doc",status:"add",data:t}}loadDatabase(){return N(this,void 0,void 0,(function*(){this.db.q.pause(),this.db.resetIndexes(!0);let e=0,t=0;const r=[],i=[],n=new K;n.on("readLine",(n=>N(this,void 0,void 0,(function*(){t++;const s=this.treatSingleLine(n);"doc"===s.type?i.push(s):"index"===s.type?r.push(s):s.data||e++})))),yield this.readData(n);for(let e=0;e<r.length;e++){const t=r[e];"add"===t.status&&(this.db.indexes[t.data.fieldName]=new M(t.data.data)),"remove"===t.status&&delete this.db.indexes[t.data.fieldName]}for(let e=0;e<i.length;e++){const t=i[e];"add"===t.status&&this.db.addToIndexes(t.data),"remove"===t.status&&this.db.removeFromIndexes(t.data)}if(t>0&&e/t>this.corruptAlertThreshold)throw new Error(`XWebDB: More than ${Math.floor(100*this.corruptAlertThreshold)}% of the data file is corrupt, the wrong decode hook might have been used. Cautiously refusing to start Datastore to prevent dataloss`);return this.db.q.start(),!0}))}readData(e){return N(this,void 0,void 0,(function*(){const t=yield this.data.values();for(let r=0;r<t.length;r++){const i=t[r];i.startsWith("$H")||"$deleted"===i||e.emit("readLine",i)}e.emit("end","")}))}deleteData(e){return N(this,void 0,void 0,(function*(){if(!this.RSA)return yield this.data.dels(e),e;const t=yield this.data.keys(),r=[],i=[];for(let n=0;n<e.length;n++){const s=e[n],o=t.find((e=>e.toString().startsWith(s+"_")))||"",a=Math.random().toString(36).substring(2,4)+Date.now(),h=s+"_"+a;r.push(o),i.push(h),t.splice(t.indexOf(o),1),t.push(h)}return yield this.data.dels(r),yield this.data.sets(i.map((e=>[e,"$deleted"]))),this.sync&&(yield this.sync.setLocalHash(t)),e}))}writeData(e){return N(this,void 0,void 0,(function*(){if(!this.RSA)return yield this.data.sets(e),e.map((e=>e[0]));const t=yield this.data.keys(),r=[],i=[];for(let n=0;n<e.length;n++){const s=e[n],o=t.find((e=>e.toString().startsWith(s[0]+"_")))||"",a=Math.random().toString(36).substring(2,4)+Date.now(),h=s[0]+"_"+a;r.push(o),i.push([h,s[1]]),t.splice(t.indexOf(o),1),t.push(h)}return yield this.data.dels(r),yield this.data.sets(i),this.sync&&(yield this.sync.setLocalHash(t)),e.map((e=>e[0]))}))}deleteEverything(){return N(this,void 0,void 0,(function*(){yield this.data.clear()}))}}class J{static new(e){const t=new this;if("object"!=typeof e||null===e)return t;const r=Object.keys(Object.assign(Object.assign({},t),e));for(let i=0;i<r.length;i++){const n=r[i];let s=t[n],o=e[n];s&&s._$SHOULD_MAP$_?void 0===o?t[n]=s.def:Array.isArray(o)?t[n]=o.map((e=>s.ctr.new(e))):t[n]=s.ctr.new(o):t[n]=void 0===o?s:o}return t}}class L extends J{constructor(){super(...arguments),this._id=r()}static stripDefaults(e){const t=JSON.parse(JSON.stringify(new this)),r=Object.keys(t),i={};for(let n=0;n<r.length;n++){const s=r[n];JSON.parse(JSON.stringify({t:t[s]}))!==JSON.parse(JSON.stringify({t:e[s]}))&&(i[s]=e[s])}return i}}class z{constructor(e=1){this._queue=[],this._pause=!1,this._ongoingCount=0,this._concurrency=1,this._resolveEmpty=()=>Promise.resolve(),this._concurrency=e}pause(){this._pause=!0}start(){this._pause=!1,this._next()}add(e){return new Promise(((t,r)=>{const i=()=>N(this,void 0,void 0,(function*(){this._ongoingCount++;try{const r=yield Promise.resolve().then(e);return this._ongoingCount--,this._next(),t(r),r}catch(e){return this._ongoingCount--,this._next(),r(e),null}}));this._ongoingCount<this._concurrency&&!this._pause?i():this._queue.push(i)}))}get waitingCount(){return this._queue.length}get ongoingCount(){return this._ongoingCount}_next(){if(!(this._ongoingCount>=this._concurrency||this._pause))if(this._queue.length>0){const e=this._queue.shift();e&&e()}else this._resolveEmpty()}}class U{constructor(e){this.ref="db",this.timestampData=!1,this.q=new z(1),this.indexes={_id:new M({fieldName:"_id",unique:!0})},this.ttlIndexes={},this.defer=0,this.deferredWrites=[],this.deferredDeletes=[],this.model=e.model||L,e.ref&&(this.ref=e.ref),this.persistence=new R({db:this,model:e.model,encode:e.encode,decode:e.decode,corruptAlertThreshold:e.corruptAlertThreshold||0,syncToRemote:e.syncToRemote,syncInterval:e.syncInterval,invalidateHash:e.invalidateHash,stripDefaults:e.stripDefaults}),this.timestampData=!!e.timestampData,e.defer&&(this.defer=e.defer||0,setInterval((()=>N(this,void 0,void 0,(function*(){this.persistence.syncInProgress||this._processDeferred()}))),e.defer))}_processDeferred(){return N(this,void 0,void 0,(function*(){if(this.deferredDeletes.length)try{const e=yield this.persistence.deleteData(this.deferredDeletes);this.deferredDeletes=this.deferredDeletes.filter((t=>-1===e.indexOf(t)))}catch(e){console.error("XWebDB: processing deferred deletes error",e),yield this.loadDatabase()}if(this.deferredWrites.length)try{const e=yield this.persistence.writeNewData(this.deferredWrites);this.deferredWrites=this.deferredWrites.filter((t=>-1===e.indexOf(t._id||"")))}catch(e){console.error("XWebDB: processing deferred writes error",e),yield this.loadDatabase()}}))}loadDatabase(){return N(this,void 0,void 0,(function*(){return yield this.persistence.loadDatabase()}))}getAllData(){return this.indexes._id.getAll()}resetIndexes(e=!1){Object.keys(this.indexes).forEach((t=>{if(e&&"_id"!==t)return delete this.indexes[t];this.indexes[t].reset()}))}ensureIndex(e){return N(this,void 0,void 0,(function*(){if(!(e=e||{}).fieldName){let e=new Error("XWebDB: Cannot create an index without a fieldName");throw e.missingFieldName=!0,e}if(this.indexes[e.fieldName])return{affectedIndex:e.fieldName};this.indexes[e.fieldName]=new M(e),void 0!==e.expireAfterSeconds&&(this.ttlIndexes[e.fieldName]=e.expireAfterSeconds);try{this.indexes[e.fieldName].insert(this.getAllData())}catch(t){throw delete this.indexes[e.fieldName],t}return yield this.persistence.writeNewIndex([{$$indexCreated:e}]),{affectedIndex:e.fieldName}}))}removeIndex(e){return N(this,void 0,void 0,(function*(){return delete this.indexes[e],yield this.persistence.deleteData([e]),{affectedIndex:e}}))}addToIndexes(e){let t,r=-1;const i=Object.keys(this.indexes);for(let n=0;n<i.length;n++)try{this.indexes[i[n]].insert(e)}catch(e){r=n,t=e;break}if(t){for(let t=0;t<r;t++)this.indexes[i[t]].remove(e);throw t}}removeFromIndexes(e){Object.keys(this.indexes).forEach((t=>{this.indexes[t].remove(e)}))}updateIndexes(e,t){let r,i=-1;const n=Object.keys(this.indexes);for(let s=0;s<n.length;s++)try{this.indexes[n[s]].update(e,t)}catch(e){i=s,r=e;break}if(r){for(let r=0;r<i;r++)this.indexes[n[r]].revertUpdate(e,t);throw r}}_isBasicType(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e||e instanceof Date||null===e}_leastCandidates(e){const t=Object.keys(this.indexes),r=Object.keys(e);let i=[];return r.forEach((r=>{this._isBasicType(e[r])&&-1!==t.indexOf(r)&&i.push(r)})),i.length>0?this.indexes[i[0]].getMatching(e[i[0]]):(r.forEach((r=>{e[r]&&e[r].hasOwnProperty("$eq")&&this._isBasicType(e[r].$eq)&&-1!==t.indexOf(r)&&i.push(r)})),i.length>0?this.indexes[i[0]].getMatching(e[i[0]].$eq):(r.forEach((r=>{e[r]&&e[r].hasOwnProperty("$in")&&-1!==t.indexOf(r)&&i.push(r)})),i.length>0?this.indexes[i[0]].getMatching(e[i[0]].$in):(r.forEach((r=>{e[r]&&-1!==t.indexOf(r)&&(e[r].hasOwnProperty("$lt")||e[r].hasOwnProperty("$lte")||e[r].hasOwnProperty("$gt")||e[r].hasOwnProperty("$gte"))&&i.push(r)})),i.length>0?this.indexes[i[0]].getBetweenBounds(e[i[0]]):this.getAllData())))}getCandidates(e,t){return N(this,void 0,void 0,(function*(){let r=this._leastCandidates(e);if(t)return Array.isArray(r)?r:null===r?[]:[r];const i=[],n=[],s=Object.keys(this.ttlIndexes);if(!r)return[];Array.isArray(r)||(r=[r]),r.forEach((e=>{let t=!0;s.forEach((r=>{void 0!==e[r]&&e[r]instanceof Date&&Date.now()>e[r].getTime()+1e3*this.ttlIndexes[r]&&(t=!1)})),t?n.push(e):e._id&&i.push(e._id)}));for(let e=0;e<i.length;e++){const t=i[e];yield this._remove({_id:t},{multi:!1})}return n}))}_insert(e){return N(this,void 0,void 0,(function*(){let t=this.prepareDocumentForInsertion(e);this._insertInCache(t);try{C()}catch(e){console.error("XWebDB: Could not do live updates due to an error:",e)}let r=Array.isArray(t)?t:[t];return this.defer?this.deferredWrites.push(...r):yield this.persistence.writeNewData(r),c(t,this.model)}))}createNewId(){let e=r();return this.indexes._id.getMatching(e).length>0&&(e=this.createNewId()),e}prepareDocumentForInsertion(e){let t=[];if(Array.isArray(e))e.forEach((e=>{t.push(this.prepareDocumentForInsertion(e))}));else{t=c(e,this.model),void 0===t._id&&(t._id=this.createNewId());const r=new Date;this.timestampData&&void 0===t.createdAt&&(t.createdAt=r),this.timestampData&&void 0===t.updatedAt&&(t.updatedAt=r),l(t)}return t}_insertInCache(e){Array.isArray(e)?this._insertMultipleDocsInCache(e):this.addToIndexes(e)}_insertMultipleDocsInCache(e){let t,r=-1;for(let i=0;i<e.length;i++)try{this.addToIndexes(e[i])}catch(e){t=e,r=i;break}if(t){for(let t=0;t<r;t++)this.removeFromIndexes(e[t]);throw t}}insert(e){return N(this,void 0,void 0,(function*(){const t=yield this.q.add((()=>this._insert(e)));return Array.isArray(t)?{docs:t,number:t.length}:{docs:[t],number:1}}))}count(e){return N(this,void 0,void 0,(function*(){const t=new j(this,e);return(yield t.exec()).length}))}find(e){return N(this,void 0,void 0,(function*(){const t=new j(this,e);return yield t.exec()}))}cursor(e){return new j(this,e)}_update(e,t,r){return N(this,void 0,void 0,(function*(){let i=void 0!==r.multi&&r.multi,n=void 0!==r.upsert&&r.upsert;const s=new j(this,e);s.limit(1);const o=yield s.__exec_unsafe();if(o.length>0){let r=0;const n=yield this.getCandidates(e),s=[];for(let o=0;o<n.length;o++)if((i||0===r)&&D(n[o],e)){r++;let e=n[o].createdAt,i=k(n[o],t,this.model);e&&(i.createdAt=e),!this.timestampData||void 0!==t.updatedAt||t.$set&&void 0!==t.$set.updatedAt||(i.updatedAt=new Date),s.push({oldDoc:n[o],newDoc:i})}this.updateIndexes(s);try{C()}catch(e){console.error("XWebDB: Could not do live updates due to an error:",e)}const o=s.map((e=>e.newDoc));return this.defer?this.deferredWrites.push(...o):yield this.persistence.writeNewData(o),{number:o.length,docs:o.map((e=>c(e,this.model))),upsert:!1}}if(0===o.length&&n){if(!t.$setOnInsert)throw new Error("XWebDB: $setOnInsert modifier is required when upserting");let e=c(t.$setOnInsert,this.model,!0);const r=yield this._insert(e);return Array.isArray(r)?{number:r.length,docs:r,upsert:!0}:{number:1,docs:[r],upsert:!0}}return{number:0,docs:[],upsert:!1}}))}update(e,t,r){return N(this,void 0,void 0,(function*(){return yield this.q.add((()=>this._update(e,t,r)))}))}_remove(e,t){return N(this,void 0,void 0,(function*(){let r=0;const i=[],n=[];let s=!!t&&!!t.multi;(yield this.getCandidates(e,!0)).forEach((t=>{D(t,e)&&(s||0===r)&&(r++,n.push(c(t,this.model)),i.push({$$deleted:!0,_id:t._id}),this.removeFromIndexes(t))}));try{C()}catch(e){console.error("XWebDB: Could not do live updates due to an error:",e)}let o=i.map((e=>e._id||""));return this.defer?this.deferredDeletes.push(...o):yield this.persistence.deleteData(o),{number:r,docs:n}}))}remove(e,t){return N(this,void 0,void 0,(function*(){return this.q.add((()=>this._remove(e,t)))}))}}const F={};function V(e,t="GET",r="",i,n=!0){return N(this,void 0,void 0,(function*(){return new Promise((s=>{var o=new XMLHttpRequest;o.addEventListener("readystatechange",(function(){if(4===this.readyState){if(!1===n)return s(this.responseText);try{let e=JSON.parse(this.responseText);s(e)}catch(e){s(this.responseText)}}})),o.open(t,(e.endpoint+"/"+r).replace(/(https?:\/{2}.*)\/{2}/,"$1/").replace(/\/$/,"")),o.setRequestHeader("Authorization",`Bearer ${e.token}`),o.setRequestHeader("Content-Type","application/json"),o.send(i)}))}))}class G{constructor({name:e,token:t,endpoint:r}){this.id="",this.name=e,this.token=t,this.endpoint=r,this.connect()}connect(){return N(this,void 0,void 0,(function*(){if(F[this.endpoint]||(F[this.endpoint]={}),F[this.endpoint][this.name])return void(this.id=F[this.endpoint][this.name]);const e=yield this.listStores();for(let t=0;t<e.length;t++){const r=e[t];F[this.endpoint][r.name]=r.id}if(F[this.endpoint][this.name])return void(this.id=F[this.endpoint][this.name]);const t=yield this.createStore(this.name);F[this.endpoint][this.name]=t,this.id=t}))}listStores(){return N(this,void 0,void 0,(function*(){const e=[];let t=1,r=1;for(;r>=t;){const i=yield V(this,"GET",`?page=${t}`);if("string"==typeof i||!i.success||!Array.isArray(i.result))throw new Error("XWebDB: Error while listing namespaces: "+JSON.stringify(i));{const n=i.result;for(let t=0;t<n.length;t++){const r=n[t];e.push({id:r.id,name:r.title})}r=i.result_info.total_pages,t++}}return e}))}createStore(e){return N(this,void 0,void 0,(function*(){const t=yield V(this,"POST","",JSON.stringify({title:e}));if("string"==typeof t||!t.success||Array.isArray(t.result))throw new Error("XWebDB: Error while creating namespace: "+JSON.stringify(t));return t.result.id}))}removeStore(){return N(this,void 0,void 0,(function*(){this.id||(yield this.connect());const e=yield V(this,"DELETE",this.id);if("string"!=typeof e&&e.success)return!0;throw new Error("XWebDB: Error while deleting namespace: "+JSON.stringify(e))}))}removeItem(e){return N(this,void 0,void 0,(function*(){this.id||(yield this.connect());const t=yield V(this,"DELETE",`${this.id}/values/${e}`);if("string"!=typeof t&&t.success)return!0;throw new Error("XWebDB: Error while deleting item: "+JSON.stringify(t))}))}setItem(e,t){return N(this,void 0,void 0,(function*(){this.id||(yield this.connect());const r=yield V(this,"PUT",`${this.id}/values/${e}`,t);if("string"!=typeof r&&r.success)return!0;throw new Error("XWebDB: Error while setting item: "+JSON.stringify(r))}))}getItem(e){return N(this,void 0,void 0,(function*(){this.id||(yield this.connect());const t=yield V(this,"GET",`${this.id}/values/${e}`,void 0,!1);if("string"!=typeof t)throw new Error("XWebDB: Error while getting item: "+JSON.stringify(t));return t}))}keys(){return N(this,void 0,void 0,(function*(){this.id||(yield this.connect());let e=[],t="";do{const r=yield V(this,"GET",`${this.id}/keys${t?`?cursor=${t}`:""}`);if("string"==typeof r||!r.success||!Array.isArray(r.result))throw new Error("XWebDB: Error while listing keys: "+JSON.stringify(r));{const i=r.result;for(let t=0;t<i.length;t++){const r=i[t];e.push(r.name)}t=r.result_info.cursor}}while(t);return e}))}removeItems(e){return N(this,void 0,void 0,(function*(){this.id||(yield this.connect());const t=e.reduce(((e,t,r)=>{const i=Math.floor(r/9999);return e[i]||(e[i]=[]),e[i].push(t),e}),[]);let r=[];for(let e=0;e<t.length;e++){const i=t[e],n=yield V(this,"DELETE",`${this.id}/bulk`,JSON.stringify(i));if("string"==typeof n||!n.success)throw new Error("XWebDB: Error while deleting item: "+JSON.stringify(n));r.push(!0)}return r}))}setItems(e){return N(this,void 0,void 0,(function*(){this.id||(yield this.connect());const t=e.reduce(((e,t,r)=>{const i=Math.floor(r/9999);return e[i]||(e[i]=[]),e[i].push(t),e}),[]);let r=[];for(let e=0;e<t.length;e++){const i=t[e],n=yield V(this,"PUT",`${this.id}/bulk`,JSON.stringify(i));if("string"==typeof n||!n.success)throw new Error("XWebDB: Error while deleting item: "+JSON.stringify(n));r.push(!0)}return r}))}getItems(e){return N(this,void 0,void 0,(function*(){if(0===e.length)return[];const t=new z(20),r=[];for(let i=0;i<e.length;i++){const n=e[i];r.push(t.add((()=>this.getItem(n))))}const i=yield Promise.all(r),n=[];for(let t=0;t<e.length;t++){let r=e[t],s=i[t];n.push({key:r,value:s})}return n}))}}var Y=Object.freeze({__proto__:null,kvAdapter:(e,t)=>r=>new G({endpoint:e,token:t,name:r})});const Q="insert",Z="update",ee="delete",te=Symbol.for("object-observer-meta-key-0");function re(e){return e.parent?re(e.parent):e}function ie(e){return JSON.parse(JSON.stringify({tmp:e})).tmp}function ne(e,t,r){const i={};i[te]=t;for(const n in e)i[n]=le(e[n],n,t,r);return i}function se(e,t,r){let i=e.length;const n=new Array(i);n[te]=t;for(let s=0;s<i;s++)n[s]=le(e[s],s,t,r);return n}function oe(e,t){try{e(t)}catch(r){console.error(`XWebDB: Failed to notify listener ${e} with ${t}`,r)}}function ae(){const e=this.batches;this.batches=[];for(const[t,r]of e)oe(t,r)}function he(e,t){let r=e;const i=t.length;do{let e=r.observers,n=e.length;for(;n--;){let i=e[n];if(t.length){let e;0===r.batches.length&&queueMicrotask(ae.bind(r));for(const t of r.batches)if(t[0]===i){e=t;break}e||(e=[i,[]],r.batches.push(e)),Array.prototype.push.apply(e[1],t)}}const s=r.parent;if(s){for(let e=0;e<i;e++){const i=t[e];t[e]=new ue(i.type,[r.ownKey,...i.path],i.value,i.oldValue,i.object,ie(re(r).proxy))}r=s}else r=null}while(r)}function le(e,t,r,i){return void 0!==i&&i.has(e)?null:"object"!=typeof e||null===e?e:Array.isArray(e)?new ye({target:e,ownKey:t,parent:r,visited:i}).proxy:e instanceof Date?e:new fe({target:e,ownKey:t,parent:r,visited:i}).proxy}const de={pop:function(){const e=this[te],t=e.target,r=t.length-1;let i=t.pop();if(i&&"object"==typeof i){const e=i[te];e&&(i=e.detach())}return he(e,[new ue(ee,[r],void 0,i,this,ie(this))]),i},push:function(){const e=this[te],t=e.target,r=arguments.length,i=new Array(r),n=t.length;for(let t=0;t<r;t++)i[t]=le(arguments[t],n+t,e);const s=Reflect.apply(t.push,t,i),o=[];for(let e=n,r=t.length;e<r;e++)o[e-n]=new ue(Q,[e],t[e],void 0,this,ie(this));return he(e,o),s},shift:function(){const e=this[te],t=e.target;let r,i,n,s,o;for(r=t.shift(),r&&"object"==typeof r&&(o=r[te],o&&(r=o.detach())),i=0,n=t.length;i<n;i++)s=t[i],s&&"object"==typeof s&&(o=s[te],o&&(o.ownKey=i));return he(e,[new ue(ee,[0],void 0,r,this,ie(this))]),r},unshift:function(){const e=this[te],t=e.target,r=arguments.length,i=new Array(r);for(let t=0;t<r;t++)i[t]=le(arguments[t],t,e);const n=Reflect.apply(t.unshift,t,i);for(let e,r=0,i=t.length;r<i;r++)if(e=t[r],e&&"object"==typeof e){const t=e[te];t&&(t.ownKey=r)}const s=i.length,o=new Array(s);for(let e=0;e<s;e++)o[e]=new ue(Q,[e],t[e],void 0,this,ie(this));return he(e,o),n},reverse:function(){const e=this[te],t=e.target;let r,i,n;for(t.reverse(),r=0,i=t.length;r<i;r++)if(n=t[r],n&&"object"==typeof n){const e=n[te];e&&(e.ownKey=r)}return he(e,[new ue("reverse",[],void 0,void 0,this,ie(this))]),this},sort:function(e){const t=this[te],r=t.target;let i,n,s;for(r.sort(e),i=0,n=r.length;i<n;i++)if(s=r[i],s&&"object"==typeof s){const e=s[te];e&&(e.ownKey=i)}return he(t,[new ue("shuffle",[],void 0,void 0,this,ie(this))]),this},fill:function(e,t,r){const i=this[te],n=i.target,s=[],o=n.length,a=n.slice(0);if(t=void 0===t?0:t<0?Math.max(o+t,0):Math.min(t,o),r=void 0===r?o:r<0?Math.max(o+r,0):Math.min(r,o),t<o&&r>t){let o;n.fill(e,t,r);for(let e,h,l=t;l<r;l++)e=n[l],n[l]=le(e,l,i),l in a?(h=a[l],h&&"object"==typeof h&&(o=h[te],o&&(h=o.detach())),s.push(new ue(Z,[l],n[l],h,this,ie(this)))):s.push(new ue(Q,[l],n[l],void 0,this,ie(this)));he(i,s)}return this},copyWithin:function(e,t,r){const i=this[te],n=i.target,s=n.length;e=e<0?Math.max(s+e,0):e,t=void 0===t?0:t<0?Math.max(s+t,0):Math.min(t,s),r=void 0===r?s:r<0?Math.max(s+r,0):Math.min(r,s);const o=Math.min(r-t,s-e);if(e<s&&e!==t&&o>0){const s=n.slice(0),a=[];n.copyWithin(e,t,r);for(let t,r,h,l=e;l<e+o;l++)t=n[l],t&&"object"==typeof t&&(t=le(t,l,i),n[l]=t),r=s[l],r&&"object"==typeof r&&(h=r[te],h&&(r=h.detach())),"object"!=typeof t&&t===r||a.push(new ue(Z,[l],t,r,this,ie(this)));he(i,a)}return this},splice:function(){const e=this[te],t=e.target,r=arguments.length,i=new Array(r),n=t.length;for(let t=0;t<r;t++)i[t]=le(arguments[t],t,e);const s=0===r?0:i[0]<0?n+i[0]:i[0],o=r<2?n-s:i[1],a=Math.max(r-2,0),h=Reflect.apply(t.splice,t,i),l=t.length;let d,u,c,f;for(let e,r=0;r<l;r++)e=t[r],e&&"object"==typeof e&&(d=e[te],d&&(d.ownKey=r));for(u=0,c=h.length;u<c;u++)f=h[u],f&&"object"==typeof f&&(d=f[te],d&&(h[u]=d.detach()));const y=[];let p;for(p=0;p<o;p++)p<a?y.push(new ue(Z,[s+p],t[s+p],h[p],this,ie(this))):y.push(new ue(ee,[s+p],void 0,h[p],this,ie(this)));for(;p<a;p++)y.push(new ue(Q,[s+p],t[s+p],void 0,this,ie(this)));return he(e,y),h}};class ue{constructor(e,t,r,i,n,s){this.type=e,this.path=t,this.value=ie(r),this.oldValue=ie(i),this.object=n,this.snapshot=s}}class ce{constructor(e,t){this.observers=[],this.batches=[];const{target:r,parent:i,ownKey:n,visited:s=new Set}=e;i&&void 0!==n?(this.parent=i,this.ownKey=n):(this.parent=null,this.ownKey=""),s.add(r);const o=t(r,this,s);s.delete(r),this.revocable=Proxy.revocable(o,this),this.proxy=this.revocable.proxy,this.target=o,this.batches=[]}detach(){return this.parent=null,this.target}set(e,t,r){let i=e[t];if(r!==i){const n=le(r,t,this);if(e[t]=n,i&&"object"==typeof i){const e=i[te];e&&(i=e.detach())}he(this,void 0===i?[new ue(Q,[t],n,void 0,this.proxy,ie(this.proxy))]:[new ue(Z,[t],n,i,this.proxy,ie(this.proxy))])}return!0}deleteProperty(e,t){let r=e[t];if(delete e[t],r&&"object"==typeof r){const e=r[te];e&&(r=e.detach())}return he(this,[new ue(ee,[t],void 0,r,this.proxy,ie(this.proxy))]),!0}}class fe extends ce{constructor(e){super(e,ne)}}class ye extends ce{constructor(e){super(e,se)}get(e,t){return de[t]||e[t]}}function pe(e){const t=ge(e)?e:new ye({target:e,ownKey:"",parent:null}).proxy;function r(e){return N(this,void 0,void 0,(function*(){return e?Array.isArray(e)?yield me(t,e):yield me(t,[e]):yield me(t)}))}function i(e){!function(e,t){const r=e[te].observers;r.some((e=>e===t))||r.push(t)}(t,e)}return{observe:i,unobserve:r,silently:function(e){return N(this,void 0,void 0,(function*(){const n=yield r();yield e(t),n.forEach((e=>i(e)))}))},observable:t}}function ge(e){return!(!e||!e[te])}function me(e,t){return N(this,void 0,void 0,(function*(){e instanceof Promise&&(e=yield Promise.resolve(e));const r=e[te].observers;if(!r.length)return[];if(!t)return r.splice(0);let i=[];for(let e=0;e<t.length;e++){const n=t[e],s=r.indexOf(n);s>-1&&i.push(r.splice(s,1)[0])}return i}))}var ve=Object.freeze({__proto__:null,observable:pe,isObservable:ge,Change:ue});let be=E;const we={avl:{AvlTree:I,Node:S},observable:ve,Cursor:j,customUtils:s,Datastore:U,Index:M,modelling:B,Q:z,Persistence:R,PersistenceEvent:K};e.Database=class{constructor(e){this.create=this.insert,this.find=this.read,this.number=this.count,this.remove=this.delete,this.ensureIndex=this.createIndex,this.model=e.model||L,this.ref=e.ref,this._datastore=new U({ref:this.ref,model:this.model,encode:e.encode,decode:e.decode,corruptAlertThreshold:e.corruptAlertThreshold,timestampData:e.timestampData,syncToRemote:e.sync?e.sync.syncToRemote:void 0,syncInterval:e.sync?e.sync.syncInterval:void 0,invalidateHash:e.sync?e.sync.invalidateHash:void 0,defer:e.deferPersistence||0,stripDefaults:e.stripDefaults||!1}),this.loaded=this._datastore.loadDatabase()}insert(e){return N(this,void 0,void 0,(function*(){return yield this._datastore.insert(e)}))}live(e={},{skip:t=0,limit:i=0,project:n={},sort:s={},toDB:o=!0,fromDB:a=!0}={}){return N(this,arguments,void 0,(function*(){const h=pe(yield this.read(...arguments));let l=()=>{},d="";var u;return o&&(l=e=>{let t={};for(let r=0;r<e.length;r++){const i=e[r];if(0!==i.path.length&&"shuffle"!==i.type&&"reverse"!==i.type)if(1===i.path.length&&"update"===i.type){let e=i.snapshot[i.path[0]],r=i.oldValue._id;t[r]=()=>this.update({_id:r},{$set:e})}else if(i.path.length>1||"update"===i.type){let e=i.snapshot[i.path[0]],r=e._id;t[r]=()=>this.upsert({_id:r},{$set:e,$setOnInsert:e})}else if("delete"===i.type){let e=i.oldValue._id;t[e]=()=>this.delete({_id:e})}else if("insert"===i.type){let e=i.value;t[e._id]=()=>this.insert(e)}}const r=Object.values(t).map((e=>e()));Promise.all(r).catch((e=>{C(),console.error("XWebDB: Reflecting observable changes to database couldn't complete due to an error:",e)}))},h.observe(l)),a&&((u={queryFilter:e,queryOptions:{skip:t,limit:i,project:n,sort:s},database:this,toDBObserver:l,observable:h}).id=r(),P.push(u),d=u.id),Object.assign(Object.assign({},h),{kill(e){return N(this,void 0,void 0,(function*(){"toDB"!==e&&e||(yield h.unobserve(l)),"fromDB"!==e&&e||function(e){const t=P.findIndex((t=>t.id===e));t>-1&&P.splice(t,1)}(d)}))}})}))}read(e={},{skip:t=0,limit:r=0,project:i={},sort:n={}}={}){return N(this,void 0,void 0,(function*(){e=y(e),n=y(n),i=y(i);const s=this._datastore.cursor(e);return n&&s.sort(n),t&&s.skip(t),r&&s.limit(r),i&&s.projection(i),yield s.exec()}))}update(e,t,r=!1){return N(this,void 0,void 0,(function*(){e=y(e||{});for(let e=0;e<be.length;e++){const r=be[e];t[r]&&(t[r]=y(t[r]))}return yield this._datastore.update(e,t,{multi:r,upsert:!1})}))}upsert(e,t,r=!1){return N(this,void 0,void 0,(function*(){e=y(e||{});for(let e=0;e<be.length;e++){const r=be[e];t[r]&&(t[r]=y(t[r]))}return yield this._datastore.update(e,t,{multi:r,upsert:!0})}))}count(e={}){return N(this,void 0,void 0,(function*(){return e=y(e||{}),yield this._datastore.count(e)}))}delete(e,t=!1){return N(this,void 0,void 0,(function*(){e=y(e||{});return yield this._datastore.remove(e,{multi:t||!1})}))}createIndex(e){return N(this,void 0,void 0,(function*(){return yield this._datastore.ensureIndex(e)}))}removeIndex(e){return N(this,void 0,void 0,(function*(){return yield this._datastore.removeIndex(e)}))}reload(){return N(this,void 0,void 0,(function*(){return yield this._datastore.persistence.loadDatabase(),{}}))}sync(){return N(this,void 0,void 0,(function*(){if(!this._datastore.persistence.sync)throw new Error("XWebDB: Can not perform sync operation unless provided with remote DB adapter");return yield this._datastore.persistence.sync.sync()}))}forceSync(){return N(this,void 0,void 0,(function*(){if(!this._datastore.persistence.sync)throw new Error("XWebDB: Can not perform sync operation unless provided with remote DB adapter");return yield this._datastore.persistence.sync._sync(!0)}))}get syncInProgress(){return this._datastore.persistence.syncInProgress}},e.Doc=L,e.SubDoc=class extends J{},e._internal=we,e.adapters=Y,e.mapSubModel=function(e,t){return{_$SHOULD_MAP$_:!0,def:t,ctr:e}},Object.defineProperty(e,"__esModule",{value:!0})}));